<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draft21 - ×“×¨××¤×˜ ×›×“×•×¨×’×œ ×‘×–××Ÿ ×××ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% {
                transform: translateY(-25%);
                animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
            }
            50% {
                transform: translateY(0);
                animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-500 to-blue-600 min-h-screen">
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, runTransaction } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCjwQYPhwTvNFNOEMlwtsmIc36PFpNF62c",
            authDomain: "draft21-418bb.firebaseapp.com",
            databaseURL: "https://draft21-418bb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "draft21-418bb",
            storageBucket: "draft21-418bb.firebasestorage.app",
            messagingSenderId: "211570854406",
            appId: "1:211570854406:web:fb2d14c3aed01fc12f5187"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const gameDocRef = doc(db, 'games', 'current');

        // State
        let gameState = null;
        let nickname = localStorage.getItem('draft21_nickname') || '';
        let selectedCaptains = [];
        let captainColorMap = {};
        let draftOrderMode = 'random';
        let manualDraftOrder = [];
        let pendingPick = null;

        // Clean player names
        function cleanPlayerNames(text) {
            return text
                .split('\n')
                .map(line => {
                    let cleaned = line.trim();
                    cleaned = cleaned.replace(/^\d+[\.\)\-\:\s]+/g, '');
                    cleaned = cleaned.replace(/^\d+/g, '');
                    cleaned = cleaned.trim();
                    return cleaned;
                })
                .filter(name => name.length > 0 && !/^\d+$/.test(name))
                .slice(0, 21);
        }

        // Initialize game
        async function initGame() {
            const unsubscribe = onSnapshot(gameDocRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    await setDoc(gameDocRef, {
                        status: 'setup',
                        players: [],
                        teams: [],
                        participants: [],
                        picks: [],
                        turn: { order: [], index: 0, direction: 1 },
                        settings: { snake: true }
                    });
                } else {
                    gameState = docSnap.data();
                    render();
                }
            });
        }

        // Add players
        async function addPlayers(text) {
            const names = cleanPlayerNames(text);
            const players = names.map((name, idx) => ({
                id: `player_${idx}_${Date.now()}`,
                name,
                available: true
            }));
            
            await updateDoc(gameDocRef, {
                players,
                status: 'captains'
            });
        }

        // Toggle captain selection
        function toggleCaptain(playerId) {
            if (selectedCaptains.includes(playerId)) {
                selectedCaptains = selectedCaptains.filter(id => id !== playerId);
                delete captainColorMap[playerId];
            } else if (selectedCaptains.length < 3) {
                selectedCaptains.push(playerId);
                captainColorMap[playerId] = ['××“×•×', '×œ×‘×Ÿ', '×©×—×•×¨'][selectedCaptains.length - 1];
            }
            render();
        }

        // Assign color to captain
        function assignColorToCaptain(captainId, color) {
            captainColorMap[captainId] = color;
            render();
        }

        // Confirm captains
        async function confirmCaptains() {
            const teams = selectedCaptains.map((captainId, idx) => {
                const captain = gameState.players.find(p => p.id === captainId);
                const color = captainColorMap[captainId] || ['××“×•×', '×œ×‘×Ÿ', '×©×—×•×¨'][idx];
                return {
                    id: `team_${idx}`,
                    name: color,
                    captain: captain.name,
                    captainId: captainId,
                    players: [captain.name]
                };
            });

            const updatedPlayers = gameState.players.map(p => ({
                ...p,
                available: !selectedCaptains.includes(p.id)
            }));

            await updateDoc(gameDocRef, {
                teams,
                players: updatedPlayers,
                status: 'lobby'
            });

            selectedCaptains = [];
            captainColorMap = {};
        }

        // Join lobby
        async function joinLobby(nick) {
            localStorage.setItem('draft21_nickname', nick);
            nickname = nick;
            
            const participants = gameState.participants || [];
            if (!participants.find(p => p.name === nick)) {
                await updateDoc(gameDocRef, {
                    participants: [...participants, { name: nick, ready: false }]
                });
            }
            render();
        }

        // Toggle ready
        async function toggleReady() {
            const participants = gameState.participants.map(p =>
                p.name === nickname ? { ...p, ready: !p.ready } : p
            );
            await updateDoc(gameDocRef, { participants });
        }

        // Start draft
        async function startDraft() {
            let order;
            if (draftOrderMode === 'random') {
                order = [...gameState.participants.map(p => p.name)].sort(() => Math.random() - 0.5);
            } else {
                order = manualDraftOrder.length > 0 ? manualDraftOrder : gameState.participants.map(p => p.name);
            }
            
            await updateDoc(gameDocRef, {
                status: 'drafting',
                turn: { order, index: 0, direction: 1 }
            });
        }

        // Select player (pending)
        function selectPlayer(playerId) {
            const currentPicker = gameState.turn.order[gameState.turn.index];
            if (currentPicker !== nickname) return;
            pendingPick = playerId;
            render();
        }

        // Cancel pick
        function cancelPick() {
            pendingPick = null;
            render();
        }

        // Confirm pick
        async function confirmPick() {
            if (!pendingPick) return;

            const currentPicker = gameState.turn.order[gameState.turn.index];
            if (currentPicker !== nickname) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameDocRef);
                    const data = gameDoc.data();
                    
                    const player = data.players.find(p => p.id === pendingPick);
                    if (!player || !player.available) {
                        throw new Error('Player not available');
                    }

                    // Snake draft for teams
                    const pickCount = data.picks.length;
                    const round = Math.floor(pickCount / data.teams.length);
                    let teamIndex;
                    
                    if (round % 2 === 0) {
                        teamIndex = pickCount % data.teams.length;
                    } else {
                        teamIndex = data.teams.length - 1 - (pickCount % data.teams.length);
                    }
                    
                    const team = data.teams[teamIndex];

                    const updatedPlayers = data.players.map(p =>
                        p.id === pendingPick ? { ...p, available: false } : p
                    );

                    const updatedTeams = data.teams.map(t =>
                        t.id === team.id ? { ...t, players: [...t.players, player.name] } : t
                    );

                    const newPick = {
                        playerId: pendingPick,
                        playerName: player.name,
                        team: team.name,
                        picker: currentPicker,
                        round: round + 1,
                        pickNumber: pickCount + 1,
                        timestamp: Date.now()
                    };

                    // Calculate next turn
                    let nextIndex = data.turn.index + data.turn.direction;
                    let nextDirection = data.turn.direction;

                    if (data.settings.snake) {
                        if (nextIndex >= data.turn.order.length) {
                            nextIndex = data.turn.order.length - 1;
                            nextDirection = -1;
                        } else if (nextIndex < 0) {
                            nextIndex = 0;
                            nextDirection = 1;
                        }
                    }

                    const availableCount = updatedPlayers.filter(p => p.available).length;
                    const newStatus = availableCount === 0 ? 'completed' : 'drafting';

                    transaction.update(gameDocRef, {
                        players: updatedPlayers,
                        teams: updatedTeams,
                        picks: [...data.picks, newPick],
                        turn: { ...data.turn, index: nextIndex, direction: nextDirection },
                        status: newStatus
                    });
                });

                pendingPick = null;
            } catch (error) {
                console.error('Error making pick:', error);
                alert('×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×‘×—×™×¨×”');
            }
        }

        // Reset draft
        async function resetDraft() {
            await updateDoc(gameDocRef, {
                status: 'lobby',
                picks: [],
                turn: { order: gameState.turn.order, index: 0, direction: 1 },
                players: gameState.players.map(p => ({
                    ...p,
                    available: !gameState.teams.some(t => t.captainId === p.id)
                })),
                teams: gameState.teams.map(t => ({
                    ...t,
                    players: [t.captain]
                }))
            });
            pendingPick = null;
        }

        // Full reset
        async function fullReset() {
            localStorage.removeItem('draft21_nickname');
            nickname = '';
            selectedCaptains = [];
            captainColorMap = {};
            manualDraftOrder = [];
            draftOrderMode = 'random';
            pendingPick = null;

            await setDoc(gameDocRef, {
                status: 'setup',
                players: [],
                teams: [],
                participants: [],
                picks: [],
                turn: { order: [], index: 0, direction: 1 },
                settings: { snake: true }
            });
        }

        // Share on WhatsApp
        function shareWhatsApp() {
            let text = 'âš½ ×ª×•×¦××•×ª ×”×“×¨××¤×˜ - Draft21\n\n';
            gameState.teams.forEach((team) => {
                if (team.name === '××“×•×') {
                    text += `ğŸ”´ ×§×‘×•×¦×” ××“×•××”\n`;
                } else if (team.name === '×œ×‘×Ÿ') {
                    text += `âšª ×§×‘×•×¦×” ×œ×‘× ×”\n`;
                } else {
                    text += `âš« ×§×‘×•×¦×” ×©×—×•×¨×”\n`;
                }
                text += `ğŸ‘‘ ×§×¤×˜×Ÿ: ${team.captain}\n`;
                text += `ğŸ‘¥ ×©×—×§× ×™× (${team.players.length}): ${team.players.join(', ')}\n\n`;
            });
            
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // Move participant in manual order
        function moveParticipantUp(index) {
            if (index === 0) return;
            [manualDraftOrder[index - 1], manualDraftOrder[index]] = [manualDraftOrder[index], manualDraftOrder[index - 1]];
            render();
        }

        function moveParticipantDown(index) {
            if (index === manualDraftOrder.length - 1) return;
            [manualDraftOrder[index], manualDraftOrder[index + 1]] = [manualDraftOrder[index + 1], manualDraftOrder[index]];
            render();
        }

        // Render function
        function render() {
            if (!gameState) {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-white text-2xl font-bold">×˜×•×¢×Ÿ Draft21...</div>
                    </div>
                `;
                return;
            }

            let html = '';

            // Setup Phase
            if (gameState.status === 'setup') {
                html = `
                    <div class="p-4">
                        <div class="max-w-2xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-2xl p-6 mt-8">
                                <div class="text-center mb-6">
                                    <h1 class="text-5xl font-bold text-green-700 mb-2">âš½ Draft21</h1>
                                    <p class="text-gray-600 text-lg">×”×“×¨××¤×˜ ×”×›×™ ××”×™×¨ ×‘×™×©×¨××œ</p>
                                </div>
                                
                                <div class="space-y-4">
                                    <label class="block">
                                        <span class="text-lg font-semibold text-gray-700">×”×“×‘×§ ×¨×©×™××ª ×©×—×§× ×™× (×¢×“ 21):</span>
                                        <textarea
                                            id="playerInput"
                                            class="mt-2 w-full h-64 p-4 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-right font-mono"
                                            placeholder="1. ×“×•×“&#10;2. ×™×•××‘&#10;3. ×¢×•××¨&#10;4. ×¨×•×¢×™&#10;5. ×ª×•××¨&#10;..."
                                        ></textarea>
                                    </label>
                                    
                                    <button
                                        onclick="handleAddPlayers()"
                                        class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-green-700 transition-all transform hover:scale-105 shadow-lg"
                                    >
                                        ×”××©×š ×œ×‘×—×™×¨×ª ×§×¤×˜× ×™× âš¡
                                    </button>
                                    
                                    <div class="text-sm text-gray-500 text-center">
                                        ğŸ’¡ ×”×“×‘×§ ×¨×©×™××” ××•×•××˜×¡××¤ - ×”××¢×¨×›×ª ×ª× ×§×” ××•×˜×•××˜×™×ª ××ª ×”××¡×¤×¨×™×
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Captains Selection Phase
            else if (gameState.status === 'captains') {
                const captainsHtml = selectedCaptains.length > 0 ? `
                    <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                        <h3 class="text-lg font-bold mb-3">×§×¤×˜× ×™× × ×‘×—×¨×™× - ×‘×—×¨ ×¦×‘×¢ ×œ×›×œ ×§×‘×•×¦×”:</h3>
                        <div class="space-y-3">
                            ${selectedCaptains.map(captainId => {
                                const captain = gameState.players.find(p => p.id === captainId);
                                const assignedColor = captainColorMap[captainId];
                                return `
                                    <div class="flex items-center gap-3 bg-white p-3 rounded-lg shadow">
                                        <span class="font-bold text-lg flex-1">${captain.name}</span>
                                        <div class="flex gap-2">
                                            ${['××“×•×', '×œ×‘×Ÿ', '×©×—×•×¨'].map(color => `
                                                <button
                                                    onclick="assignColorToCaptain('${captainId}', '${color}')"
                                                    class="px-4 py-2 rounded-lg font-bold transition-all ${
                                                        assignedColor === color
                                                            ? color === '××“×•×' ? 'bg-red-500 text-white scale-110' :
                                                              color === '×œ×‘×Ÿ' ? 'bg-gray-100 text-gray-800 border-2 border-gray-400 scale-110' :
                                                              'bg-gray-800 text-white scale-110'
                                                            : color === '××“×•×' ? 'bg-red-200 text-red-800 hover:bg-red-300' :
                                                              color === '×œ×‘×Ÿ' ? 'bg-gray-50 text-gray-600 border border-gray-300 hover:bg-gray-100' :
                                                              'bg-gray-300 text-gray-700 hover:bg-gray-400'
                                                    }"
                                                >
                                                    ${color}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : '';

                html = `
                    <div class="p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-2xl p-6 mt-8">
                                <h2 class="text-3xl font-bold text-center mb-6 text-green-700">ğŸ‘‘ ×‘×—×¨ 3 ×§×¤×˜× ×™×</h2>
                                
                                <div class="flex gap-4 mb-6">
                                    <button
                                        onclick="confirmCaptains()"
                                        ${selectedCaptains.length !== 3 ? 'disabled' : ''}
                                        class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 disabled:bg-gray-400 transition-all transform hover:scale-105 shadow-lg text-xl"
                                    >
                                        âœ“ ××™×©×•×¨ (${selectedCaptains.length}/3)
                                    </button>
                                </div>

                                ${captainsHtml}

                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                    ${gameState.players.map(player => `
                                        <button
                                            onclick="toggleCaptain('${player.id}')"
                                            class="p-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-md ${
                                                selectedCaptains.includes(player.id)
                                                    ? 'bg-gradient-to-br from-green-500 to-green-600 text-white shadow-xl scale-105'
                                                    : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                                            }"
                                        >
                                            ${selectedCaptains.includes(player.id) ? 'ğŸ‘‘ ' : ''}
                                            ${player.name}
                                        </button>
                                    `).join('')}
                                </div>
                                
                                <button
                                    onclick="fullReset()"
                                    class="mt-6 w-full bg-red-500 text-white py-2 rounded-lg font-bold hover:bg-red-600 text-sm"
                                >
                                    ğŸ”„ ×”×ª×—×œ ××—×“×©
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Lobby Phase
            else if (gameState.status === 'lobby') {
                if (!nickname) {
                    html = `
                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                                <h2 class="text-3xl font-bold text-center mb-6 text-green-700">ğŸ® ×”×¦×˜×¨×£ ×œ×“×¨××¤×˜</h2>
                                <input
                                    type="text"
                                    id="nicknameInput"
                                    placeholder="×”×›× ×¡ ×©× ×›×™× ×•×™"
                                    class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none text-right text-lg mb-4"
                                />
                                <button
                                    onclick="handleJoinLobby()"
                                    class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-green-700 transition-all transform hover:scale-105 shadow-lg"
                                >
                                    ×”×¦×˜×¨×£ ğŸš€
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    const myParticipant = gameState.participants.find(p => p.name === nickname);
                    const readyCount = gameState.participants.filter(p => p.ready).length;
                    
                    if (draftOrderMode === 'manual' && manualDraftOrder.length === 0) {
                        manualDraftOrder = gameState.participants.map(p => p.name);
                    }

                    const manualOrderHtml = draftOrderMode === 'manual' && manualDraftOrder.length > 0 ? `
                        <div class="space-y-2">
                            <p class="text-sm text-gray-600 mb-2">×¡×“×¨ ×”×‘×—×™×¨×” (×’×¨×•×¨ ××• ×”×©×ª××© ×‘×—×¦×™×):</p>
                            ${manualDraftOrder.map((name, index) => `
                                <div class="flex items-center gap-2 bg-white p-3 rounded-lg shadow">
                                    <span class="font-bold text-gray-500 w-8">${index + 1}.</span>
                                    <span class="flex-1 font-bold">${name}</span>
                                    <div class="flex gap-1">
                                        <button
                                            onclick="moveParticipantUp(${index})"
                                            ${index === 0 ? 'disabled' : ''}
                                            class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                        >
                                            â–²
                                        </button>
                                        <button
                                            onclick="moveParticipantDown(${index})"
                                            ${index === manualDraftOrder.length - 1 ? 'disabled' : ''}
                                            class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                        >
                                            â–¼
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '';

                    html = `
                        <div class="p-4">
                            <div class="max-w-4xl mx-auto">
                                <div class="bg-white rounded-2xl shadow-2xl p-6 mt-8">
                                    <h2 class="text-3xl font-bold text-center mb-6 text-green-700">ğŸ¯ ×—×“×¨ ×”××ª× ×”</h2>
                                    
                                    <div class="mb-6">
                                        <h3 class="text-xl font-bold mb-3">×§×‘×•×¦×•×ª:</h3>
                                        <div class="grid grid-cols-3 gap-4">
                                            ${gameState.teams.map(team => `
                                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-xl shadow-md border-2 border-gray-200">
                                                    <div class="text-center font-bold text-xl mb-2">
                                                        ${team.name === '××“×•×' ? 'ğŸ”´ ××“×•××”' : team.name === '×œ×‘×Ÿ' ? 'âšª ×œ×‘× ×”' : 'âš« ×©×—×•×¨×”'}
                                                    </div>
                                                    <div class="text-center text-sm text-gray-600">ğŸ‘‘ ${team.captain}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xl font-bold mb-3">××©×ª×ª×¤×™× (${gameState.participants.length}):</h3>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            ${gameState.participants.map(p => `
                                                <div class="p-3 rounded-xl font-bold transition-all ${
                                                    p.ready 
                                                        ? 'bg-gradient-to-br from-green-100 to-green-200 text-green-800 shadow-md' 
                                                        : 'bg-gray-100 text-gray-600'
                                                }">
                                                    ${p.name} ${p.ready ? 'âœ“' : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                                        <h3 class="text-xl font-bold mb-3">×¡×“×¨ ×”×“×¨××¤×˜:</h3>
                                        <div class="flex gap-3 mb-4">
                                            <button
                                                onclick="setDraftOrderMode('random')"
                                                class="flex-1 py-3 rounded-lg font-bold transition-all ${
                                                    draftOrderMode === 'random'
                                                        ? 'bg-purple-600 text-white shadow-lg'
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }"
                                            >
                                                ğŸ² ××§×¨××™
                                            </button>
                                            <button
                                                onclick="setDraftOrderMode('manual')"
                                                class="flex-1 py-3 rounded-lg font-bold transition-all ${
                                                    draftOrderMode === 'manual'
                                                        ? 'bg-purple-600 text-white shadow-lg'
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }"
                                            >
                                                âœ‹ ×™×“× ×™
                                            </button>
                                        </div>

                                        ${manualOrderHtml}
                                    </div>

                                    <div class="space-y-3">
                                        <button
                                            onclick="toggleReady()"
                                            class="w-full py-4 rounded-xl font-bold text-xl transition-all transform hover:scale-105 shadow-lg ${
                                                myParticipant?.ready
                                                    ? 'bg-gray-400 text-white'
                                                    : 'bg-green-600 text-white hover:bg-green-700'
                                            }"
                                        >
                                            ${myParticipant?.ready ? 'âœ“ ××•×›×Ÿ!' : '×¡××Ÿ ×›××•×›×Ÿ'}
                                        </button>

                                        <button
                                            onclick="startDraft()"
                                            class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-blue-700 transition-all transform hover:scale-105 shadow-lg"
                                        >
                                            ğŸ¬ ×”×ª×—×œ ×“×¨××¤×˜ (${readyCount} ××•×›× ×™×)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // Drafting Phase
            else if (gameState.status === 'drafting') {
                const currentPicker = gameState.turn.order[gameState.turn.index];
                const isMyTurn = currentPicker === nickname;
                const availablePlayers = gameState.players.filter(p => p.available);
                const totalPicks = gameState.players.length - gameState.teams.length;
                const progress = (gameState.picks.length / totalPicks) * 100;
                const pendingPlayer = pendingPick ? gameState.players.find(p => p.id === pendingPick) : null;

                // Current team
                const pickCount = gameState.picks.length;
                const round = Math.floor(pickCount / gameState.teams.length);
                let teamIndex;
                if (round % 2 === 0) {
                    teamIndex = pickCount % gameState.teams.length;
                } else {
                    teamIndex = gameState.teams.length - 1 - (pickCount % gameState.teams.length);
                }
                const currentTeam = gameState.teams[teamIndex];

                const confirmButtons = isMyTurn && pendingPick ? `
                    <div class="flex gap-4 mb-6">
                        <button
                            onclick="confirmPick()"
                            class="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-green-700 shadow-lg transform hover:scale-105 transition-all"
                        >
                            âœ“ ×¡×™×™×
                        </button>
                        <button
                            onclick="cancelPick()"
                            class="flex-1 bg-red-500 text-white py-4 rounded-xl font-bold text-xl hover:bg-red-600 shadow-lg transform hover:scale-105 transition-all"
                        >
                            âœ— ×‘×˜×œ
                        </button>
                    </div>
                ` : '';

                html = `
                    <div class="p-4">
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-2xl p-6 mt-8">
                                <div class="text-center mb-6">
                                    <h2 class="text-3xl font-bold text-green-700 mb-3">âš¡ ×”×“×¨××¤×˜ ×”×—×œ!</h2>
                                    <div class="text-2xl font-bold mb-3">
                                        ${isMyTurn ? `
                                            <div>
                                                <span class="text-green-600 animate-pulse">ğŸ¯ ×”×ª×•×¨ ×©×œ×š (${nickname})!</span>
                                                ${pendingPlayer ? `<div class="mt-2 text-xl text-blue-600">×‘×—×¨×ª ××ª: <span class="font-bold">${pendingPlayer.name}</span></div>` : ''}
                                            </div>
                                        ` : `
                                            <span class="text-gray-600">â³ ×”×ª×•×¨ ×©×œ: ${currentPicker}</span>
                                        `}
                                    </div>
                                    
                                    <div class="text-lg mb-3 text-gray-700">
                                        ×”×‘×—×™×¨×” ×”×‘××” ×œ×§×‘×•×¦×”: 
                                        <span class="font-bold">
                                            ${currentTeam.name === '××“×•×' ? 'ğŸ”´ ×§×‘×•×¦×” ××“×•××”' : currentTeam.name === '×œ×‘×Ÿ' ? 'âšª ×§×‘×•×¦×” ×œ×‘× ×”' : 'âš« ×§×‘×•×¦×” ×©×—×•×¨×”'}
                                        </span>
                                    </div>
                                    
                                    <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                                        <div class="bg-green-600 h-4 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        ${gameState.picks.length} / ${totalPicks} ×‘×—×™×¨×•×ª (${availablePlayers.length} × ×•×ª×¨×•)
                                    </div>
                                </div>

                                ${confirmButtons}

                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <h3 class="text-xl font-bold mb-3">×©×—×§× ×™× ×–××™× ×™×:</h3>
                                        <div class="grid grid-cols-2 gap-2 max-h-96 overflow-y-auto p-2">
                                            ${availablePlayers.map(player => `
                                                <button
                                                    onclick="selectPlayer('${player.id}')"
                                                    ${!isMyTurn ? 'disabled' : ''}
                                                    class="p-4 rounded-xl font-bold text-lg transition-all ${
                                                        pendingPick === player.id
                                                            ? 'bg-blue-600 text-white shadow-xl scale-105'
                                                            : isMyTurn
                                                            ? 'bg-gradient-to-br from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700 transform hover:scale-105 shadow-lg cursor-pointer'
                                                            : 'bg-gray-200 text-gray-500 cursor-not-allowed'
                                                    }"
                                                >
                                                    ${player.name}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div>
                                        <h3 class="text-xl font-bold mb-3">×§×‘×•×¦×•×ª:</h3>
                                        <div class="space-y-3">
                                            ${gameState.teams.map(team => `
                                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-xl shadow-md border-2 border-gray-200">
                                                    <div class="font-bold text-lg mb-2">
                                                        ${team.name === '××“×•×' ? 'ğŸ”´ ×§×‘×•×¦×” ××“×•××”' : team.name === '×œ×‘×Ÿ' ? 'âšª ×§×‘×•×¦×” ×œ×‘× ×”' : 'âš« ×§×‘×•×¦×” ×©×—×•×¨×”'}
                                                        - ğŸ‘‘ ${team.captain}
                                                    </div>
                                                    <div class="text-sm text-gray-600">
                                                        (${team.players.length}) ${team.players.join(', ')}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                ${gameState.picks.length > 0 ? `
                                    <div>
                                        <h3 class="text-xl font-bold mb-3">ğŸ“‹ ×‘×—×™×¨×•×ª ××—×¨×•× ×•×ª:</h3>
                                        <div class="space-y-2 max-h-48 overflow-y-auto">
                                            ${[...gameState.picks].reverse().slice(0, 5).map(pick => `
                                                <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-3 rounded-lg text-sm shadow-sm">
                                                    <span class="font-bold text-green-700">${pick.picker}</span> ×‘×—×¨ ××ª 
                                                    <span class="font-bold text-blue-700">${pick.playerName}</span> ×œ
                                                    <span class="font-bold">
                                                        ${pick.team === '××“×•×' ? '×§×‘×•×¦×” ××“×•××”' : pick.team === '×œ×‘×Ÿ' ? '×§×‘×•×¦×” ×œ×‘× ×”' : '×§×‘×•×¦×” ×©×—×•×¨×”'}
                                                    </span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Completed Phase
            else if (gameState.status === 'completed') {
                html = `
                    <div class="p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-2xl p-6 mt-8">
                                <h2 class="text-5xl font-bold text-center mb-3 text-green-700">ğŸ† ×”×“×¨××¤×˜ ×”×¡×ª×™×™×!</h2>
                                <p class="text-center text-gray-600 mb-6 text-lg">×”×§×‘×•×¦×•×ª ××•×›× ×•×ª ×œ××©×—×§!</p>
                                
                                <div class="space-y-4 mb-6">
                                    ${gameState.teams.map(team => `
                                        <div class="p-6 rounded-xl shadow-lg border-4 ${
                                            team.name === '××“×•×' ? 'bg-red-50 border-red-300' :
                                            team.name === '×œ×‘×Ÿ' ? 'bg-gray-50 border-gray-300' :
                                            'bg-gray-800 border-gray-600 text-white'
                                        }">
                                            <h3 class="text-3xl font-bold mb-3">
                                                ${team.name === '××“×•×' ? 'ğŸ”´ ×§×‘×•×¦×” ××“×•××”' : team.name === '×œ×‘×Ÿ' ? 'âšª ×§×‘×•×¦×” ×œ×‘× ×”' : 'âš« ×§×‘×•×¦×” ×©×—×•×¨×”'}
                                            </h3>
                                            <div class="mb-2 text-lg">
                                                <span class="font-bold">ğŸ‘‘ ×§×¤×˜×Ÿ:</span> ${team.captain}
                                            </div>
                                            <div>
                                                <span class="font-bold">ğŸ‘¥ ×©×—×§× ×™× (${team.players.length}):</span>
                                                <div class="mt-2 text-lg leading-relaxed">${team.players.join(', ')}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="space-y-3">
                                    <button
                                        onclick="shareWhatsApp()"
                                        class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-5 rounded-xl font-bold text-xl hover:from-green-600 hover:to-green-700 transform hover:scale-105 transition-all shadow-lg"
                                    >
                                        ğŸ“¤ ×©×ª×£ ×‘×•×•××˜×¡××¤
                                    </button>
                                    
                                    <button
                                        onclick="resetDraft()"
                                        class="w-full bg-yellow-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-yellow-600 transition-all shadow-lg"
                                    >
                                        ğŸ”„ ××¤×¡ ×“×¨××¤×˜ (×©××•×¨ ×©×—×§× ×™×)
                                    </button>
                                    
                                    <button
                                        onclick="fullReset()"
                                        class="w-full bg-red-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-red-600 transition-all shadow-lg"
                                    >
                                        ğŸ—‘ï¸ ×”×ª×—×œ ××—×“×© ×œ×’××¨×™
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('app').innerHTML = html;
        }

        // Global functions
        window.handleAddPlayers = function() {
            const text = document.getElementById('playerInput').value;
            if (text.trim()) {
                addPlayers(text);
            }
        };

        window.toggleCaptain = toggleCaptain;
        window.assignColorToCaptain = assignColorToCaptain;
        window.confirmCaptains = confirmCaptains;
        
        window.handleJoinLobby = function() {
            const nick = document.getElementById('nicknameInput').value;
            if (nick.trim()) {
                joinLobby(nick);
            }
        };
        
        window.toggleReady = toggleReady;
        window.startDraft = startDraft;
        window.selectPlayer = selectPlayer;
        window.cancelPick = cancelPick;
        window.confirmPick = confirmPick;
        window.resetDraft = resetDraft;
        window.fullReset = fullReset;
        window.shareWhatsApp = shareWhatsApp;
        window.moveParticipantUp = moveParticipantUp;
        window.moveParticipantDown = moveParticipantDown;
        
        window.setDraftOrderMode = function(mode) {
            draftOrderMode = mode;
            if (mode === 'manual' && gameState.participants) {
                manualDraftOrder = gameState.participants.map(p => p.name);
            }
            render();
        };

        // Initialize
        initGame();
    </script>
</body>
</html>