<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
   <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Draft21</title>
  
  <!-- 📱 אייקונים לשמירה ב-Home Screen -->
  <link rel="icon" type="image/png" href="draft21icon.png">
  <link rel="apple-touch-icon" href="draft21icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="draft21icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="draft21icon.png">
  <link rel="icon" type="image/png" sizes="512x512" href="draft21icon.png">
  
  <!-- PWA - שם האפליקציה בהום סקרין -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Draft21">
  <meta name="application-name" content="Draft21">
  <meta name="theme-color" content="#3b82f6">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Draft21 - כלי דראפט כדורגל</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
    .animate-bounce { animation: bounce 1s infinite; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .confetti { position: fixed; animation: fall 3s linear; pointer-events: none; font-size: 24px; z-index: 9999; }
  </style>
</head>
<body class="min-h-screen">
  <div id="app">
    <div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl shadow-2xl p-8 text-center">
        <div class="text-6xl mb-4 animate-bounce">🏆</div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Draft21</h1>
        <div class="animate-pulse text-gray-600">טוען את המערכת...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, runTransaction, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const app = initializeApp({
      apiKey: "AIzaSyBqz4oHoqGtnzjWqgzjWmwsUv6Kny75QpM",
      authDomain: "draft21-eabc3.firebaseapp.com",
      projectId: "draft21-eabc3",
      storageBucket: "draft21-eabc3.firebasestorage.app",
      messagingSenderId: "489648686113",
      appId: "1:489648686113:web:94d3605a0e5a871a434f60",
    });

    const db = getFirestore(app);
    const COLORS = { Red: 'bg-red-500', White: 'bg-gray-100', Black: 'bg-gray-900' };
    
    let S = {
      phase: 'setup', input: '', nick: '', id: '', host: false,
      caps: [], assigns: {}, order: [], manual: false, manualColors: true
    };

    function init() {
      const n = localStorage.getItem('d21_nick');
      const i = localStorage.getItem('d21_id');
      if (n) S.nick = n;
      if (i) S.id = i;
      if (localStorage.getItem('d21_host') === '1') S.host = true;
      try {
        const c = localStorage.getItem('d21_caps');
        const a = localStorage.getItem('d21_assign');
        if (c) S.caps = JSON.parse(c);
        if (a) S.assigns = JSON.parse(a);
      } catch (e) {}
      
      onSnapshot(doc(db, 'games', 'current'), snap => {
        if (snap.exists()) S.phase = snap.data().status || 'setup';
        render();
      });
    }

    function clean(t) {
      return t.split('\n').map(l => l.trim().replace(/^\d+[\.\)\-\s]+/,'').replace(/[\d\.\)\-]+$/,'').replace(/\d+/g,'').trim()).filter(n => n.length > 0).slice(0,21);
    }

    async function initGame() {
      const names = clean(S.input);
      if (!names.length) return;
      const plrs = names.map((n,i) => ({id:'p'+i, name:n, available:true}));
      await setDoc(doc(db,'games','current'), {
        status:'captains', players:plrs, teams:[], participants:[], picks:[],
        turn:{order:[],index:0,direction:1}, settings:{snake:true}, pendingPick:null, lastPick:null
      });
      S.host = true;
      localStorage.setItem('d21_host','1');
    }

    function togCap(id) {
      const i = S.caps.indexOf(id);
      if (i > -1) S.caps.splice(i,1);
      else if (S.caps.length < 3) S.caps.push(id);
      localStorage.setItem('d21_caps', JSON.stringify(S.caps));
      render();
    }

    async function randCaps() {
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const av = snap.data().players.filter(p => p.available);
      const sh = av.slice().sort(() => Math.random()-.5);
      S.caps = sh.slice(0,3).map(p => p.id);
      
      // אם בחרו בחירה אקראית של צבעים, נקצה גם צבעים
      if (!S.manualColors) {
        const cols = ['Red','White','Black'].sort(() => Math.random()-.5);
        S.assigns = {};
        S.caps.forEach((c,i) => S.assigns[c] = cols[i]);
        localStorage.setItem('d21_assign', JSON.stringify(S.assigns));
      }
      
      localStorage.setItem('d21_caps', JSON.stringify(S.caps));
      render();
    }

    function assignT(cid, col) {
      S.assigns[cid] = col;
      localStorage.setItem('d21_assign', JSON.stringify(S.assigns));
      render();
    }

    function togColorsMode() {
      S.manualColors = !S.manualColors;
      
      // אם עברנו למצב אקראי וכבר יש קפטנים, נקצה צבעים אקראיים
      if (!S.manualColors && S.caps.length === 3) {
        const cols = ['Red','White','Black'].sort(() => Math.random()-.5);
        S.assigns = {};
        S.caps.forEach((c,i) => S.assigns[c] = cols[i]);
        localStorage.setItem('d21_assign', JSON.stringify(S.assigns));
      }
      
      render();
    }

    function randColors() {
      if (S.caps.length === 3) {
        const cols = ['Red','White','Black'].sort(() => Math.random()-.5);
        S.assigns = {};
        S.caps.forEach((c,i) => S.assigns[c] = cols[i]);
        localStorage.setItem('d21_assign', JSON.stringify(S.assigns));
        render();
      }
    }

    async function finCaps() {
      if (S.caps.length !== 3 || Object.keys(S.assigns).length !== 3) return;
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      const tms = S.caps.map(cid => {
        const cap = gd.players.find(p => p.id === cid);
        return {name:S.assigns[cid], captain:cap.name, captainId:cid, players:[cap.name]};
      });
      const up = gd.players.map(p => ({...p, available:!S.caps.includes(p.id)}));
      await updateDoc(doc(db,'games','current'), {teams:tms, players:up, status:'lobby'});
    }

    async function joinLob() {
      if (!S.nick.trim()) return;
      const pid = S.id || 'p'+Date.now();
      S.id = pid;
      localStorage.setItem('d21_id', pid);
      localStorage.setItem('d21_nick', S.nick);
      
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      const ex = gd.participants.find(p => p.id === pid);
      const pdata = ex || {id:pid, nick:S.nick, ready:false, teamName:null};
      const nps = ex ? gd.participants.map(p => p.id === pid ? pdata : p) : [...gd.participants, pdata];
      await updateDoc(doc(db,'games','current'), {participants:nps});
    }

    async function selTeam(tn) {
      if (!S.id) return;
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      const nps = gd.participants.map(p => p.id === S.id ? {...p, teamName:tn} : p);
      await updateDoc(doc(db,'games','current'), {participants:nps});
    }

    async function togReady() {
      if (!S.id) return;
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      const my = gd.participants.find(p => p.id === S.id);
      if (!my || !my.teamName) return;
      const nps = gd.participants.map(p => p.id === S.id ? {...p, ready:!p.ready} : p);
      await updateDoc(doc(db,'games','current'), {participants:nps});
    }

    async function togMan() {
      S.manual = !S.manual;
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      if (S.manual && S.order.length === 0) {
        S.order = gd.teams.map(t => t.name);
      }
      render();
    }

    function moveO(tn, d) {
      const i = S.order.indexOf(tn);
      if (i === -1) return;
      const ni = i + d;
      if (ni < 0 || ni >= S.order.length) return;
      const tmp = S.order[ni];
      S.order[ni] = S.order[i];
      S.order[i] = tmp;
      render();
    }

    function randO() {
      S.order = S.order.slice().sort(() => Math.random()-.5);
      render();
    }

    async function startD() {
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      let ord = [];
      if (S.manual && S.order.length > 0) {
        ord = S.order;
      } else {
        ord = gd.teams.map(t => t.name).sort(() => Math.random()-.5);
      }
      const readyT = gd.teams.filter(t => gd.participants.some(p => p.teamName === t.name && p.ready)).map(t => t.name);
      const fOrd = ord.filter(tn => readyT.includes(tn));
      await updateDoc(doc(db,'games','current'), {status:'draft', turn:{order:fOrd, index:0, direction:1}});
    }

    function getTurn(gd) {
      if (gd.turn.order.length === 0) return null;
      const tn = gd.turn.order[gd.turn.index % gd.turn.order.length];
      const t = gd.teams.find(tm => tm.name === tn);
      if (!t) return null;
      const my = S.id && gd.participants.find(p => p.id === S.id);
      const isMy = my && my.teamName === tn;
      return {team:t, captain:t.captain, teamName:tn, isMyTurn:isMy};
    }

    async function makePk(pid) {
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      const ti = getTurn(gd);
      if (!ti || !ti.isMyTurn || gd.pendingPick) return;
      const pl = gd.players.find(p => p.id === pid);
      if (!pl || !pl.available) return;
      
      // שמירת מזהה המשתמש שבחר
      await updateDoc(doc(db,'games','current'), {
        pendingPick:{
          playerId:pid, 
          playerName:pl.name, 
          teamName:ti.teamName,
          pickerId:S.id  // הוספנו את מזהה הבוחר
        }
      });
    }

    async function confPk() {
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      
      // בדיקה שרק הבוחר יכול לאשר
      if (!gd.pendingPick || gd.pendingPick.pickerId !== S.id) return;
      
      await runTransaction(db, async t => {
        const snap = await t.get(doc(db,'games','current'));
        if (!snap.exists()) return;
        const gd = snap.data();
        if (!gd.pendingPick) return;
        const {playerId:pid, playerName:pn, teamName:tn} = gd.pendingPick;
        const pl = gd.players.find(p => p.id === pid);
        if (!pl || !pl.available) return;
        const up = gd.players.map(p => p.id === pid ? {...p, available:false} : p);
        const ut = gd.teams.map(tm => tm.name === tn ? {...tm, players:[...tm.players, pn]} : tm);
        const upi = [...gd.picks, {teamName:tn, playerName:pn}];
        let nti = gd.turn.index + 1;
        const finFirst = nti >= gd.turn.order.length && gd.turn.direction === 1;
        const finRev = nti >= gd.turn.order.length * 2;
        if (finFirst) gd.turn.direction = -1;
        const snek = finFirst && gd.settings.snake;
        let done = up.filter(p => p.available).length === 0 || finRev;
        const nu = {players:up, teams:ut, picks:upi, pendingPick:null, lastPick:{playerName:pn, teamName:tn}};
        if (snek) {
          nu.turn = {order:gd.turn.order.slice().reverse(), index:0, direction:-1};
        } else if (done) {
          nu.status = 'complete';
        } else {
          nu.turn = {...gd.turn, index:nti};
        }
        t.update(doc(db,'games','current'), nu);
      });
    }

    async function undoPk() {
      await runTransaction(db, async t => {
        const snap = await t.get(doc(db,'games','current'));
        if (!snap.exists()) return;
        const gd = snap.data();
        if (!gd.lastPick) return;
        const {playerName:pn, teamName:tn} = gd.lastPick;
        const pl = gd.players.find(p => p.name === pn);
        if (pl) pl.available = true;
        const tm = gd.teams.find(t => t.name === tn);
        if (tm) tm.players = tm.players.filter(p => p !== pn);
        const npi = gd.picks.slice(0,-1);
        let nti = gd.turn.index - 1;
        if (nti < 0) {
          nti = gd.turn.order.length - 1;
          if (gd.turn.direction === -1) {
            gd.turn.direction = 1;
            gd.turn.order = gd.turn.order.slice().reverse();
          }
        }
        t.update(doc(db,'games','current'), {
          players:gd.players, teams:gd.teams, picks:npi,
          turn:{...gd.turn, index:nti}, lastPick:npi.length>0?npi[npi.length-1]:null
        });
      });
    }

    async function canPend() {
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      
      // בדיקה שרק הבוחר יכול לבטל
      if (!gd.pendingPick || gd.pendingPick.pickerId !== S.id) return;
      
      await updateDoc(doc(db,'games','current'), {pendingPick:null});
    }

    async function rstDraft() {
      const snap = await getDoc(doc(db,'games','current'));
      if (!snap.exists()) return;
      const gd = snap.data();
      const up = gd.players.map(p => {
        const isC = gd.teams.some(t => t.captainId === p.id);
        return {...p, available:!isC};
      });
      const ut = gd.teams.map(t => ({...t, players:[t.captain]}));
      await updateDoc(doc(db,'games','current'), {
        status:'lobby', players:up, teams:ut, picks:[], pendingPick:null,
        lastPick:null, turn:{order:[], index:0, direction:1}
      });
      S.order = [];
      S.manual = false;
    }

    async function fullRst() {
      if (confirm('האם אתה בטוח? פעולה זו תמחק את כל הנתונים!')) {
        await setDoc(doc(db,'games','current'), {
          status:'setup', players:[], teams:[], participants:[], picks:[],
          turn:{order:[],index:0,direction:1}, settings:{snake:true}, pendingPick:null, lastPick:null
        });
        localStorage.removeItem('d21_host');
        localStorage.removeItem('d21_caps');
        localStorage.removeItem('d21_assign');
        S.host = false;
        S.caps = [];
        S.assigns = {};
        S.order = [];
        S.manual = false;
        S.manualColors = true;
      }
    }

    function shareWA() {
      const snap = doc(db,'games','current');
      getDoc(snap).then(s => {
        if (!s.exists()) return;
        const gd = s.data();
        let txt = '*🏆 תוצאות הדראפט:*\n\n';
        gd.teams.forEach(t => {
          txt += `*${t.name}:*\n`;
          t.players.forEach(p => txt += `• ${p}\n`);
          txt += '\n';
        });
        window.open('https://wa.me/?text='+encodeURIComponent(txt));
      });
    }

    function confetti() {
      const emojis = ['🎉','🎊','⚽','🏆','✨','🌟'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const e = document.createElement('div');
          e.className = 'confetti';
          e.textContent = emojis[Math.floor(Math.random()*emojis.length)];
          e.style.left = Math.random()*100+'%';
          e.style.animationDuration = (2+Math.random()*2)+'s';
          document.body.appendChild(e);
          setTimeout(() => e.remove(), 3000);
        }, i*50);
      }
    }

    function render() {
      getDoc(doc(db,'games','current')).then(snap => {
        let h = '';
        const gd = snap.exists() ? snap.data() : null;
        
        if (!gd || S.phase === 'setup') h = rSetup();
        else if (S.phase === 'captains') h = rCaps(gd);
        else if (S.phase === 'lobby') h = rLobby(gd);
        else if (S.phase === 'draft') h = rDraft(gd);
        else if (S.phase === 'complete') { h = rComp(gd); setTimeout(confetti,100); }
        
        document.getElementById('app').innerHTML = h;
      });
    }

    function rSetup() {
      let h = '<div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 p-4"><div class="max-w-2xl mx-auto">'+
        '<div class="bg-white rounded-3xl shadow-2xl p-8"><div class="text-center mb-8">'+
        '<div class="text-7xl mb-4 animate-bounce">⚽</div><h1 class="text-4xl font-bold text-gray-800 mb-2">Draft21</h1>'+
        '<p class="text-gray-600">כלי הדראפט האולטימטיבי</p></div>';
      
      if (S.host) {
        h += '<div class="mb-4 text-center">'+
          '<button onclick="hFullR()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600">🗑️ איפוס מוחלט</button>'+
          '</div>';
      }
      
      h += '<div class="space-y-6">'+
        '<div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-2xl p-6 border-2 border-green-300">'+
        '<h3 class="text-xl font-bold mb-4 text-green-700">📋 הכנס את רשימת השחקנים</h3>'+
        '<textarea id="inp" placeholder="הדבק כאן את הרשימה...\nשחקן 1\nשחקן 2\nשחקן 3" class="w-full h-40 p-4 rounded-xl border-2 border-green-200" onkeyup="document.getElementById(\'cnt\').textContent=clean(this.value).length"></textarea>'+
        '<div class="flex justify-between items-center mt-3"><span class="text-sm text-green-600">שחקנים: <b id="cnt">0</b>/21</span>'+
        '<span class="text-xs text-gray-500">המערכת תנקה מספרים אוטומטית</span></div></div>'+
        '<button onclick="hInitG()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:scale-105 transition">🚀 התחל משחק חדש</button>'+
        '</div></div></div></div>';
      return h;
    }

    function rCaps(gd) {
      let h = '<div class="min-h-screen bg-gradient-to-br from-purple-500 to-pink-600 p-4"><div class="max-w-4xl mx-auto">'+
        '<div class="bg-white rounded-3xl shadow-2xl p-8"><div class="text-center mb-8">'+
        '<h2 class="text-3xl font-bold mb-2">בחירת קפטנים</h2>'+
        '<p class="text-gray-600">בחר 3 קפטנים והקצה להם צבעים</p></div>';
      
      if (S.host) {
        h += '<div class="mb-6 text-center">'+
          '<button onclick="hFullR()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600">🗑️ איפוס מוחלט</button>'+
          '</div>';
      }
      
      h += '<div class="grid grid-cols-3 md:grid-cols-4 gap-3 mb-6">';
      gd.players.filter(p => p.available).forEach(p => {
        const sel = S.caps.includes(p.id);
        h += '<button onclick="hTogC(\''+p.id+'\')" class="p-4 rounded-xl font-medium '+(sel?'bg-blue-500 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200')+'">'+p.name+(sel?' ✓':'')+'</button>';
      });
      h += '</div><div class="flex justify-center mb-6">'+
        '<button onclick="hRandC()" class="bg-purple-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-purple-600">🎲 בחירה אקראית</button></div>';
      
      // בחירת שיטה להקצאת צבעים
      if (S.caps.length === 3) {
        h += '<div class="bg-gray-50 rounded-2xl p-6 mb-6">'+
          '<div class="flex items-center justify-between mb-4">'+
          '<h3 class="text-xl font-bold">הקצה צבעים לקפטנים:</h3>'+
          '<button onclick="hTogColMode()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-600">'+
          (S.manualColors ? '🎯 ידני' : '🎲 אקראי')+'</button></div>';
        
        if (S.manualColors) {
          // בחירה ידנית של צבעים
          h += '<div class="space-y-3">';
          S.caps.forEach(cid => {
            const cap = gd.players.find(p => p.id === cid);
            h += '<div class="bg-white rounded-xl p-4 border-2 border-gray-200"><h4 class="font-bold mb-2">'+cap.name+'</h4><div class="grid grid-cols-3 gap-2">';
            ['Red','White','Black'].forEach(col => {
              const ass = S.assigns[cid] === col;
              h += '<button onclick="hAssT(\''+cid+'\',\''+col+'\')" class="p-3 rounded-lg '+(ass?'ring-4 ring-blue-400':'hover:scale-105')+' transition">'+
                '<div class="w-8 h-8 rounded-full '+COLORS[col]+' mx-auto mb-1"></div>'+
                '<p class="text-xs font-medium">'+col+'</p></button>';
            });
            h += '</div></div>';
          });
          h += '</div>';
        } else {
          // הצגת הקצאה אקראית
          h += '<div class="bg-blue-50 rounded-xl p-4 border-2 border-blue-300">'+
            '<p class="text-blue-700 text-center mb-3">הצבעים יוקצו אקראית</p>';
          
          if (Object.keys(S.assigns).length === 3) {
            h += '<div class="grid grid-cols-3 gap-3">';
            S.caps.forEach(cid => {
              const cap = gd.players.find(p => p.id === cid);
              const col = S.assigns[cid];
              h += '<div class="bg-white rounded-lg p-3 text-center">'+
                '<div class="w-12 h-12 rounded-full '+COLORS[col]+' mx-auto mb-2"></div>'+
                '<p class="font-bold text-sm">'+cap.name+'</p>'+
                '<p class="text-xs text-gray-600">'+col+'</p></div>';
            });
            h += '</div>';
          } else {
            h += '<button onclick="hRandCol()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold hover:bg-blue-600 mt-3">🎲 הגרל צבעים</button>';
          }
          
          h += '</div>';
        }
        
        h += '</div>';
      }
      
      h += '<button onclick="hFinC()" '+(S.caps.length!==3||Object.keys(S.assigns).length!==3?'disabled':'')+' class="w-full bg-green-500 text-white py-4 rounded-xl font-bold text-lg disabled:bg-gray-300 disabled:cursor-not-allowed">'+
        '✓ אישור הקפטנים ('+S.caps.length+'/3, '+Object.keys(S.assigns).length+' צבעים)</button>'+
        '</div></div></div>';
      return h;
    }

    function rLobby(gd) {
      const readyC = gd.participants.filter(p => p.ready && p.teamName).length;
      const rc = readyC;
      const my = S.id ? gd.participants.find(p => p.id === S.id) : null;
      
      let h = '<div class="min-h-screen bg-gradient-to-br from-teal-500 to-cyan-600 p-4"><div class="max-w-4xl mx-auto">'+
        '<div class="bg-white rounded-3xl shadow-2xl p-8"><div class="text-center mb-8">'+
        '<h2 class="text-3xl font-bold mb-2">👥 לובי המתנה</h2>'+
        '<p class="text-gray-600">כולם מוזמנים להצטרף!</p></div>';
      
      if (S.host) {
        h += '<div class="mb-6 text-center space-x-2 flex gap-2 justify-center">'+
          '<button onclick="hRstD()" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-600">🔄 אפס דראפט</button>'+
          '<button onclick="hFullR()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600">🗑️ איפוס מוחלט</button>'+
          '</div>';
      }
      
      if (!my) {
        h += '<div class="bg-blue-50 rounded-2xl p-6 mb-6 border-2 border-blue-300">'+
          '<h3 class="text-xl font-bold mb-3 text-blue-700">הצטרף למשחק:</h3>'+
          '<input id="nickIn" type="text" placeholder="הכנס את השם שלך..." value="'+S.nick+'" class="w-full p-3 rounded-lg border-2 border-blue-200 mb-3">'+
          '<button onclick="hJoinL()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold hover:bg-blue-600">🎮 כניסה למשחק</button></div>';
      }
      h += '<div class="mb-6"><h3 class="text-xl font-bold mb-3">👥 משתתפים ('+gd.participants.length+'):</h3><div class="space-y-2">';
      gd.participants.forEach(p => {
        const tm = gd.teams.find(t => t.name === p.teamName);
        h += '<div class="flex items-center justify-between p-3 rounded-xl bg-gray-50 border-2 '+(p.ready?'border-green-400':'border-gray-200')+'">'+
          '<div class="flex items-center gap-3">'+(p.teamName?'<div class="w-8 h-8 rounded-full '+COLORS[p.teamName]+'"></div>':'')+
          '<div><span class="font-medium block">'+p.nick+'</span>'+(tm?'<span class="text-xs text-gray-600">קבוצה: '+tm.name+'</span>':'<span class="text-xs text-red-600">לא בחר קבוצה</span>')+
          '</div></div>'+(p.ready?'<span class="text-2xl">✓</span>':'')+'</div>';
      });
      h += '</div></div>';
      if (my) {
        if (!my.teamName) {
          h += '<div class="mb-4 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-xl">'+
            '<p class="font-bold text-yellow-800 mb-3 text-center">בחר את הקבוצה שלך:</p><div class="grid grid-cols-3 gap-3">';
          gd.teams.forEach(t => {
            const taken = gd.participants.some(p => p.teamName === t.name && p.id !== S.id);
            h += '<button onclick="hSelT(\''+t.name+'\')" '+(taken?'disabled':'')+' class="p-4 rounded-xl '+(taken?'bg-gray-200 opacity-50 cursor-not-allowed':'bg-white border-2 border-gray-300 hover:border-blue-500')+'">'+
              '<div class="w-12 h-12 rounded-full '+COLORS[t.name]+' mx-auto mb-2"></div>'+
              '<p class="font-bold text-sm">'+t.name+'</p><p class="text-xs text-gray-600">'+t.captain+'</p>'+(taken?'<p class="text-xs text-red-600 mt-1">תפוס</p>':'')+'</button>';
          });
          h += '</div></div>';
        }
        h += '<button onclick="hTogR()" '+(!my.teamName?'disabled':'')+' class="w-full py-4 rounded-xl font-bold mb-4 '+(!my.teamName?'bg-gray-200 text-gray-400 cursor-not-allowed':my.ready?'bg-gray-300 text-gray-700':'bg-green-500 text-white hover:bg-green-600')+'">'+(my.ready?'ביטול מוכן':my.teamName?'אני מוכן!':'בחר קבוצה קודם')+'</button>';
      }
      if (S.host && rc > 0) {
        h += '<div class="border-t-2 pt-6 mt-6"><h3 class="text-xl font-bold mb-4">הגדרות דראפט</h3><div class="mb-4">'+
          '<button onclick="hTogMan()" class="w-full py-3 rounded-xl font-medium '+(S.manual?'bg-purple-500 text-white':'bg-gray-200 text-gray-700')+'">'+(S.manual?'✓ סדר ידני פעיל':'סדר אקראי (לחץ לסדר ידני)')+'</button></div>';
        if (S.manual && S.order.length > 0) {
          h += '<div class="bg-gray-50 rounded-xl p-4 mb-4"><div class="flex items-center justify-between mb-3">'+
            '<h4 class="font-bold text-gray-700">סדר הקבוצות:</h4>'+
            '<button onclick="hRandO()" class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded-lg hover:bg-purple-200">🔀 ערבב</button></div>'+
            '<p class="text-xs text-gray-500 mb-3">הסדר יהפוך כל סיבוב</p><div class="space-y-2">';
          S.order.forEach((tn,idx) => {
            const tm = gd.teams.find(t => t.name === tn);
            if (tm) {
              h += '<div class="flex items-center gap-2 bg-white p-3 rounded-lg"><span class="font-bold text-lg text-gray-500 w-8">'+(idx+1)+'.</span>'+
                '<div class="w-8 h-8 rounded-full '+COLORS[tn]+'"></div><div class="flex-1">'+
                '<span class="font-bold">'+tn+'</span><span class="text-sm text-gray-500 mr-2">('+tm.captain+')</span></div>'+
                '<div class="flex gap-1"><button onclick="hMoveO(\''+tn+'\',-1)" '+(idx===0?'disabled':'')+' class="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-30">↑</button>'+
                '<button onclick="hMoveO(\''+tn+'\',1)" '+(idx===S.order.length-1?'disabled':'')+' class="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-30">↓</button></div></div>';
            }
          });
          h += '</div></div>';
        }
        h += '</div>';
      }
      if (S.host) {
        h += '<button onclick="hStartD()" '+(rc===0?'disabled':'')+' class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-4 rounded-xl font-bold text-lg disabled:opacity-50 flex items-center justify-center gap-2">▶️ התחל דראפט ('+rc+' מוכנים)</button>';
      }
      h += '</div></div></div>';
      return h;
    }

    function rDraft(gd) {
      const ti = getTurn(gd);
      let h = '<div class="min-h-screen bg-gradient-to-br from-green-600 to-teal-600 p-4"><div class="max-w-6xl mx-auto">';
      if (ti) {
        h += '<div class="mb-6 p-6 rounded-3xl shadow-xl '+(ti.isMyTurn?'bg-yellow-400 animate-pulse':'bg-white')+'">'+
          '<div class="text-center"><p class="text-2xl font-bold mb-2">'+(ti.isMyTurn?'🔥 התור שלך לבחור! 🔥':'⏳ התור של: '+ti.captain)+'</p>'+
          '<p class="text-lg font-medium">קבוצה: <span class="font-bold">'+ti.team.name+'</span></p>'+
          '<div class="mt-2 inline-flex items-center gap-2 text-xs '+(ti.isMyTurn?'text-gray-700':'text-green-600')+' bg-white bg-opacity-50 px-3 py-1 rounded-full">'+
          '<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>מסונכרן בזמן אמת</div></div></div>';
      }
      if (gd.pendingPick) {
        const canConfirm = gd.pendingPick.pickerId === S.id;
        h += '<div class="mb-6 p-6 rounded-2xl bg-orange-100 border-4 border-orange-400 shadow-xl">'+
          '<div class="text-center"><p class="text-lg font-bold text-orange-800 mb-3">✓ נבחר: '+gd.pendingPick.playerName+'</p>';
        
        if (canConfirm) {
          // רק הבוחר יכול לאשר
          h += '<div class="flex gap-3 justify-center">'+
            '<button onclick="hConfP()" class="bg-green-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-600">✓ סיימתי - עבור לתור הבא</button>'+
            '<button onclick="hCanPend()" class="bg-gray-400 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-500">✗ בטל בחירה</button>'+
            '</div>';
        } else {
          // אחרים רק רואים מי נבחר
          h += '<p class="text-sm text-gray-600 mt-2">ממתינים לאישור הקפטן...</p>';
        }
        
        h += '</div></div>';
      }
      h += '<div class="bg-white rounded-3xl shadow-2xl p-6 mb-6"><div class="flex items-center justify-between mb-4">'+
        '<h3 class="text-2xl font-bold">שחקנים זמינים</h3>';
      if (S.host && gd.lastPick) {
        h += '<button onclick="hUndoP()" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg font-bold hover:bg-red-200">↶ אחורה</button>';
      }
      h += '</div><div class="grid grid-cols-2 md:grid-cols-4 gap-3">';
      gd.players.filter(p => p.available).forEach(pl => {
        const canP = ti && ti.isMyTurn && !gd.pendingPick;
        const isPend = gd.pendingPick && gd.pendingPick.playerId === pl.id;
        h += '<button onclick="hMakePk(\''+pl.id+'\')" '+(!canP?'disabled':'')+' class="p-4 rounded-xl border-2 '+(isPend?'bg-orange-400 text-white border-orange-600 scale-105 animate-pulse':canP?'bg-gradient-to-br from-blue-400 to-purple-500 text-white border-purple-600 hover:scale-105':'bg-gray-100 text-gray-500 border-gray-300 cursor-not-allowed')+'">'+pl.name+'</button>';
      });
      h += '</div></div><div class="grid md:grid-cols-3 gap-4 mb-6">';
      gd.teams.forEach(t => {
        h += '<div class="bg-white rounded-3xl shadow-xl p-6">'+
          '<div class="w-12 h-12 rounded-full '+COLORS[t.name]+' mx-auto mb-3"></div>'+
          '<h3 class="text-xl font-bold text-center mb-2">'+t.name+'</h3>'+
          '<p class="text-sm text-gray-600 text-center mb-4">קפטן: '+t.captain+'</p><div class="space-y-2">';
        t.players.forEach(p => {
          h += '<div class="bg-gray-100 p-2 rounded-lg text-center text-sm">'+p+'</div>';
        });
        h += '</div></div>';
      });
      h += '</div>';
      if (S.host) {
        h += '<div class="flex gap-2"><button onclick="hRstD()" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600">🔄 אפס דראפט</button>'+
          '<button onclick="hFullR()" class="px-4 bg-gray-500 text-white py-3 rounded-xl font-bold hover:bg-gray-600" title="איפוס מלא">🗑️</button></div>';
      }
      h += '</div></div>';
      return h;
    }

    function rComp(gd) {
      let h = '<div class="min-h-screen bg-gradient-to-br from-yellow-400 to-orange-500 p-4"><div class="max-w-4xl mx-auto">'+
        '<div class="bg-white rounded-3xl shadow-2xl p-8 mb-6"><div class="text-center mb-8">'+
        '<div class="text-7xl mb-4 animate-bounce">🏆</div><h2 class="text-4xl font-bold mb-2">הדראפט הסתיים!</h2>'+
        '<p class="text-gray-600">הנה הקבוצות שלכם</p></div><div class="grid md:grid-cols-3 gap-6 mb-8">';
      gd.teams.forEach(t => {
        h += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 border-4 border-gray-300">'+
          '<div class="w-16 h-16 rounded-full '+COLORS[t.name]+' mx-auto mb-4"></div>'+
          '<h3 class="text-2xl font-bold text-center mb-3">'+t.name+'</h3>'+
          '<div class="bg-yellow-100 border-2 border-yellow-400 rounded-lg p-3 mb-4">'+
          '<p class="text-center font-bold text-yellow-800">👑 '+t.captain+'</p></div><div class="space-y-2">';
        t.players.filter(p => p !== t.captain).forEach(p => {
          h += '<div class="bg-white p-3 rounded-lg text-center border border-gray-200">'+p+'</div>';
        });
        h += '</div></div>';
      });
      h += '</div><div class="space-y-4">'+
        '<button onclick="hShareWA()" class="w-full bg-green-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-600 flex items-center justify-center gap-2">📤 שתף בוואטסאפ</button>';
      if (S.host) {
        h += '<div class="flex gap-2">'+
          '<button onclick="hRstD()" class="flex-1 bg-gray-500 text-white py-3 rounded-xl font-bold hover:bg-gray-600">🔄 התחל דראפט חדש</button>'+
          '<button onclick="hFullR()" class="px-4 bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600" title="איפוס מלא">🗑️</button></div>';
      }
      h += '</div></div></div></div>';
      return h;
    }

    window.hInitG = () => { S.input = document.getElementById('inp').value; initGame(); };
    window.hTogC = togCap;
    window.hRandC = randCaps;
    window.hAssT = assignT;
    window.hFinC = finCaps;
    window.hJoinL = () => { S.nick = document.getElementById('nickIn').value; joinLob(); };
    window.hSelT = selTeam;
    window.hTogR = togReady;
    window.hTogMan = togMan;
    window.hMoveO = moveO;
    window.hRandO = randO;
    window.hStartD = startD;
    window.hMakePk = makePk;
    window.hConfP = confPk;
    window.hUndoP = undoPk;
    window.hCanPend = canPend;
    window.hRstD = rstDraft;
    window.hShareWA = shareWA;
    window.hFullR = fullRst;
    window.hTogColMode = togColorsMode;
    window.hRandCol = randColors;

    init();
  </script>
</body>
</html>
