<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draft21 - דראפט כדורגל בזמן אמת</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-500 to-blue-600 min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-white text-2xl font-bold">טוען Draft21...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, runTransaction } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCjwQYPhwTvNFNOEMlwtsmIc36PFpNF62c",
            authDomain: "draft21-418bb.firebaseapp.com",
            projectId: "draft21-418bb",
            storageBucket: "draft21-418bb.firebasestorage.app",
            messagingSenderId: "211570854406",
            appId: "1:211570854406:web:fb2d14c3aed01fc12f5187"
        };

        // Initialize Firebase
        let app, db, gameDocRef;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            gameDocRef = doc(db, 'games', 'current');
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md">
                        <h2 class="text-2xl font-bold text-red-600 mb-4">שגיאה באתחול</h2>
                        <p class="text-gray-700">${error.message}</p>
                    </div>
                </div>
            `;
        }

        // State
        let gameState = null;
        let nickname = localStorage.getItem('draft21_nickname') || '';
        let selectedCaptains = [];
        let captainColorMap = {};
        let draftOrderMode = 'random';
        let manualDraftOrder = [];
        let pendingPick = null;

        // Clean player names
        function cleanPlayerNames(text) {
            return text
                .split('\n')
                .map(line => {
                    let cleaned = line.trim();
                    cleaned = cleaned.replace(/^\d+[\.\)\-\:\s]+/g, '');
                    cleaned = cleaned.replace(/^\d+/g, '');
                    return cleaned.trim();
                })
                .filter(name => name.length > 0 && !/^\d+$/.test(name))
                .slice(0, 21);
        }

        // Initialize game
        async function initGame() {
            try {
                const unsubscribe = onSnapshot(gameDocRef, async (docSnap) => {
                    if (!docSnap.exists()) {
                        await setDoc(gameDocRef, {
                            status: 'setup',
                            players: [],
                            teams: [],
                            participants: [],
                            picks: [],
                            turn: { order: [], index: 0, direction: 1 },
                            settings: { snake: true }
                        });
                    } else {
                        gameState = docSnap.data();
                        render();
                    }
                }, (error) => {
                    console.error('Firestore listener error:', error);
                });
            } catch (error) {
                console.error('Init game error:', error);
            }
        }

        // Add players
        async function addPlayers(text) {
            const names = cleanPlayerNames(text);
            const players = names.map((name, idx) => ({
                id: `player_${idx}_${Date.now()}`,
                name,
                available: true
            }));
            
            await updateDoc(gameDocRef, {
                players,
                status: 'captains'
            });
        }

        // Toggle captain
        function toggleCaptain(playerId) {
            if (selectedCaptains.includes(playerId)) {
                selectedCaptains = selectedCaptains.filter(id => id !== playerId);
                delete captainColorMap[playerId];
            } else if (selectedCaptains.length < 3) {
                selectedCaptains.push(playerId);
                captainColorMap[playerId] = ['אדום', 'לבן', 'שחור'][selectedCaptains.length - 1];
            }
            render();
        }

        // Assign color
        function assignColorToCaptain(captainId, color) {
            captainColorMap[captainId] = color;
            render();
        }

        // Confirm captains
        async function confirmCaptains() {
            const teams = selectedCaptains.map((captainId, idx) => {
                const captain = gameState.players.find(p => p.id === captainId);
                const color = captainColorMap[captainId] || ['אדום', 'לבן', 'שחור'][idx];
                return {
                    id: `team_${idx}`,
                    name: color,
                    captain: captain.name,
                    captainId: captainId,
                    players: [captain.name]
                };
            });

            const updatedPlayers = gameState.players.map(p => ({
                ...p,
                available: !selectedCaptains.includes(p.id)
            }));

            await updateDoc(gameDocRef, {
                teams,
                players: updatedPlayers,
                status: 'lobby'
            });

            selectedCaptains = [];
            captainColorMap = {};
        }

        // Join lobby
        async function joinLobby(nick) {
            localStorage.setItem('draft21_nickname', nick);
            nickname = nick;
            
            const participants = gameState.participants || [];
            if (!participants.find(p => p.name === nick)) {
                await updateDoc(gameDocRef, {
                    participants: [...participants, { name: nick, ready: false }]
                });
            }
            render();
        }

        // Toggle ready
        async function toggleReady() {
            const participants = gameState.participants.map(p =>
                p.name === nickname ? { ...p, ready: !p.ready } : p
            );
            await updateDoc(gameDocRef, { participants });
        }

        // Start draft
        async function startDraft() {
            let order;
            if (draftOrderMode === 'random') {
                order = [...gameState.participants.map(p => p.name)].sort(() => Math.random() - 0.5);
            } else {
                order = manualDraftOrder.length > 0 ? manualDraftOrder : gameState.participants.map(p => p.name);
            }
            
            await updateDoc(gameDocRef, {
                status: 'drafting',
                turn: { order, index: 0, direction: 1 }
            });
        }

        // Select player
        function selectPlayer(playerId) {
            const currentPicker = gameState.turn.order[gameState.turn.index];
            if (currentPicker !== nickname) return;
            pendingPick = playerId;
            render();
        }

        // Cancel pick
        function cancelPick() {
            pendingPick = null;
            render();
        }

        // Confirm pick
        async function confirmPick() {
            if (!pendingPick) return;
            const currentPicker = gameState.turn.order[gameState.turn.index];
            if (currentPicker !== nickname) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameDocRef);
                    const data = gameDoc.data();
                    
                    const player = data.players.find(p => p.id === pendingPick);
                    if (!player || !player.available) throw new Error('Player not available');

                    const pickCount = data.picks.length;
                    const round = Math.floor(pickCount / data.teams.length);
                    let teamIndex = round % 2 === 0 ? pickCount % data.teams.length : data.teams.length - 1 - (pickCount % data.teams.length);
                    const team = data.teams[teamIndex];

                    const updatedPlayers = data.players.map(p => p.id === pendingPick ? { ...p, available: false } : p);
                    const updatedTeams = data.teams.map(t => t.id === team.id ? { ...t, players: [...t.players, player.name] } : t);

                    let nextIndex = data.turn.index + data.turn.direction;
                    let nextDirection = data.turn.direction;
                    if (data.settings.snake) {
                        if (nextIndex >= data.turn.order.length) {
                            nextIndex = data.turn.order.length - 1;
                            nextDirection = -1;
                        } else if (nextIndex < 0) {
                            nextIndex = 0;
                            nextDirection = 1;
                        }
                    }

                    const availableCount = updatedPlayers.filter(p => p.available).length;
                    const newStatus = availableCount === 0 ? 'completed' : 'drafting';

                    transaction.update(gameDocRef, {
                        players: updatedPlayers,
                        teams: updatedTeams,
                        picks: [...data.picks, {
                            playerId: pendingPick,
                            playerName: player.name,
                            team: team.name,
                            picker: currentPicker,
                            round: round + 1,
                            pickNumber: pickCount + 1,
                            timestamp: Date.now()
                        }],
                        turn: { ...data.turn, index: nextIndex, direction: nextDirection },
                        status: newStatus
                    });
                });
                pendingPick = null;
            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה בביצוע הבחירה');
            }
        }

        // Reset draft
        async function resetDraft() {
            await updateDoc(gameDocRef, {
                status: 'lobby',
                picks: [],
                turn: { order: gameState.turn.order, index: 0, direction: 1 },
                players: gameState.players.map(p => ({ ...p, available: !gameState.teams.some(t => t.captainId === p.id) })),
                teams: gameState.teams.map(t => ({ ...t, players: [t.captain] }))
            });
            pendingPick = null;
        }

        // Full reset
        async function fullReset() {
            localStorage.removeItem('draft21_nickname');
            nickname = '';
            selectedCaptains = [];
            captainColorMap = {};
            manualDraftOrder = [];
            draftOrderMode = 'random';
            pendingPick = null;

            await setDoc(gameDocRef, {
                status: 'setup',
                players: [],
                teams: [],
                participants: [],
                picks: [],
                turn: { order: [], index: 0, direction: 1 },
                settings: { snake: true }
            });
        }

        // Share WhatsApp
        function shareWhatsApp() {
            let text = '⚽ תוצאות הדראפט - Draft21\n\n';
            gameState.teams.forEach((team) => {
                text += `${team.name === 'אדום' ? '🔴 קבוצה אדומה' : team.name === 'לבן' ? '⚪ קבוצה לבנה' : '⚫ קבוצה שחורה'}\n`;
                text += `👑 קפטן: ${team.captain}\n`;
                text += `👥 שחקנים (${team.players.length}): ${team.players.join(', ')}\n\n`;
            });
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        // Move participant
        function moveParticipantUp(index) {
            if (index === 0) return;
            [manualDraftOrder[index - 1], manualDraftOrder[index]] = [manualDraftOrder[index], manualDraftOrder[index - 1]];
            render();
        }

        function moveParticipantDown(index) {
            if (index === manualDraftOrder.length - 1) return;
            [manualDraftOrder[index], manualDraftOrder[index + 1]] = [manualDraftOrder[index + 1], manualDraftOrder[index]];
            render();
        }

        // Render
        function render() {
            if (!gameState) return;
            
            const app = document.getElementById('app');
            let html = '';

            if (gameState.status === 'setup') {
                html = `<div class="p-4"><div class="max-w-2xl mx-auto"><div class="bg-white rounded-2xl shadow-2xl p-6 mt-8"><div class="text-center mb-6"><h1 class="text-5xl font-bold text-green-700 mb-2">⚽ Draft21</h1><p class="text-gray-600 text-lg">הדראפט הכי מהיר בישראל</p></div><div class="space-y-4"><label class="block"><span class="text-lg font-semibold text-gray-700">הדבק רשימת שחקנים (עד 21):</span><textarea id="playerInput" class="mt-2 w-full h-64 p-4 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-right font-mono" placeholder="1. דוד
2. יואב
3. עומר..."></textarea></label><button onclick="handleAddPlayers()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-green-700 transition-all shadow-lg">המשך לבחירת קפטנים ⚡</button></div></div></div></div>`;
            } else if (gameState.status === 'captains') {
                html = `<div class="p-4"><div class="max-w-4xl mx-auto"><div class="bg-white rounded-2xl shadow-2xl p-6 mt-8"><h2 class="text-3xl font-bold text-center mb-6 text-green-700">👑 בחר 3 קפטנים</h2><button onclick="confirmCaptains()" ${selectedCaptains.length !== 3 ? 'disabled' : ''} class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 disabled:bg-gray-400 mb-6">✓ אישור (${selectedCaptains.length}/3)</button><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">${gameState.players.map(p => `<button onclick="toggleCaptain('${p.id}')" class="p-4 rounded-xl font-bold text-lg ${selectedCaptains.includes(p.id) ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-800'}">${selectedCaptains.includes(p.id) ? '👑 ' : ''}${p.name}</button>`).join('')}</div></div></div></div>`;
            } else if (gameState.status === 'lobby') {
                if (!nickname) {
                    html = `<div class="flex items-center justify-center min-h-screen p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full"><h2 class="text-3xl font-bold text-center mb-6 text-green-700">🎮 הצטרף לדראפט</h2><input type="text" id="nicknameInput" placeholder="הכנס שם כינוי" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none text-right text-lg mb-4"/><button onclick="handleJoinLobby()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-green-700">הצטרף 🚀</button></div></div>`;
                } else {
                    html = `<div class="p-4"><div class="max-w-4xl mx-auto"><div class="bg-white rounded-2xl shadow-2xl p-6 mt-8"><h2 class="text-3xl font-bold text-center mb-6 text-green-700">🎯 חדר המתנה</h2><div class="mb-6"><h3 class="text-xl font-bold mb-3">קבוצות:</h3><div class="grid grid-cols-3 gap-4">${gameState.teams.map(t => `<div class="bg-gray-100 p-4 rounded-xl text-center"><div class="font-bold text-xl">${t.name === 'אדום' ? '🔴' : t.name === 'לבן' ? '⚪' : '⚫'} ${t.name}</div><div class="text-sm">👑 ${t.captain}</div></div>`).join('')}</div></div><button onclick="toggleReady()" class="w-full py-4 rounded-xl font-bold text-xl mb-3 ${gameState.participants.find(p => p.name === nickname)?.ready ? 'bg-gray-400' : 'bg-green-600'} text-white">✓ מוכן</button><button onclick="startDraft()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl">🎬 התחל דראפט</button></div></div></div>`;
                }
            } else if (gameState.status === 'drafting') {
                const currentPicker = gameState.turn.order[gameState.turn.index];
                const isMyTurn = currentPicker === nickname;
                const available = gameState.players.filter(p => p.available);
                html = `<div class="p-4"><div class="max-w-6xl mx-auto"><div class="bg-white rounded-2xl shadow-2xl p-6 mt-8"><h2 class="text-3xl font-bold text-center mb-6 text-green-700">⚡ הדראפט החל!</h2><div class="text-center text-2xl font-bold mb-6">${isMyTurn ? `🎯 התור שלך!` : `⏳ התור של: ${currentPicker}`}</div>${isMyTurn && pendingPick ? `<div class="flex gap-4 mb-6"><button onclick="confirmPick()" class="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold text-xl">✓ סיים</button><button onclick="cancelPick()" class="flex-1 bg-red-500 text-white py-4 rounded-xl font-bold text-xl">✗ בטל</button></div>` : ''}<div class="grid grid-cols-2 gap-2 mb-6">${available.map(p => `<button onclick="selectPlayer('${p.id}')" ${!isMyTurn ? 'disabled' : ''} class="p-4 rounded-xl font-bold ${pendingPick === p.id ? 'bg-blue-600 text-white' : isMyTurn ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}">${p.name}</button>`).join('')}</div></div></div></div>`;
            } else if (gameState.status === 'completed') {
                html = `<div class="p-4"><div class="max-w-4xl mx-auto"><div class="bg-white rounded-2xl shadow-2xl p-6 mt-8"><h2 class="text-5xl font-bold text-center mb-6 text-green-700">🏆 הדראפט הסתיים!</h2>${gameState.teams.map(t => `<div class="p-6 rounded-xl shadow-lg mb-4 ${t.name === 'אדום' ? 'bg-red-50' : t.name === 'לבן' ? 'bg-gray-50' : 'bg-gray-800 text-white'}"><h3 class="text-3xl font-bold mb-3">${t.name === 'אדום' ? '🔴' : t.name === 'לבן' ? '⚪' : '⚫'} קבוצה ${t.name}</h3><div class="mb-2 text-lg"><span class="font-bold">👑 קפטן:</span> ${t.captain}</div><div><span class="font-bold">👥 שחקנים:</span> ${t.players.join(', ')}</div></div>`).join('')}<button onclick="shareWhatsApp()" class="w-full bg-green-600 text-white py-5 rounded-xl font-bold text-xl mb-3">📤 שתף בוואטסאפ</button><button onclick="fullReset()" class="w-full bg-red-500 text-white py-4 rounded-xl font-bold text-lg">🗑️ התחל מחדש</button></div></div></div>`;
            }

            app.innerHTML = html;
        }

        // Global functions
        window.handleAddPlayers = () => {
            const text = document.getElementById('playerInput').value;
            if (text.trim()) addPlayers(text);
        };
        window.toggleCaptain = toggleCaptain;
        window.assignColorToCaptain = assignColorToCaptain;
        window.confirmCaptains = confirmCaptains;
        window.handleJoinLobby = () => {
            const nick = document.getElementById('nicknameInput').value;
            if (nick.trim()) joinLobby(nick);
        };
        window.toggleReady = toggleReady;
        window.startDraft = startDraft;
        window.selectPlayer = selectPlayer;
        window.cancelPick = cancelPick;
        window.confirmPick = confirmPick;
        window.resetDraft = resetDraft;
        window.fullReset = fullReset;
        window.shareWhatsApp = shareWhatsApp;
        window.moveParticipantUp = moveParticipantUp;
        window.moveParticipantDown = moveParticipantDown;
        window.setDraftOrderMode = (mode) => {
            draftOrderMode = mode;
            if (mode === 'manual' && gameState.participants) {
                manualDraftOrder = gameState.participants.map(p => p.name);
            }
            render();
        };

        // Initialize
        initGame();
    </script>
</body>
</html>
