<!DOCTYPE html>

const firebaseConfig = {
  apiKey: "AIzaSyCjwQYPhwTvNFNOEMlwtsmIc36PFpNF62c",
  authDomain: "draft21-418bb.firebaseapp.com",
  projectId: "draft21-418bb",
  storageBucket: "draft21-418bb.firebasestorage.app",
  messagingSenderId: "211570854406",
  appId: "1:211570854406:web:fb2d14c3aed01fc12f5187"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let state = {
  phase: 'setup',
  playerInput: '',
  nickname: '',
  myId: '',
  isHost: false,
  selectedCaptains: [],
  teamAssignments: {},
  draftOrder: [],
  manualOrder: false
};

const TEAM_COLORS = {
  Red: { bg: 'bg-red-500' },
  White: { bg: 'bg-gray-100' },
  Black: { bg: 'bg-gray-900' }
};

function init() {
  const stored = localStorage.getItem('draft21_nickname');
  const storedId = localStorage.getItem('draft21_id');
  const isHost = localStorage.getItem('draft21_is_host') === 'true';
  
  if (stored) state.nickname = stored;
  if (storedId) state.myId = storedId;
  if (isHost) state.isHost = true;

  try {
    const sc = localStorage.getItem('draft21_selected_captains');
    const sa = localStorage.getItem('draft21_team_assignments');
    if (sc) state.selectedCaptains = JSON.parse(sc);
    if (sa) state.teamAssignments = JSON.parse(sa);
  } catch (e) {}

  onSnapshot(doc(db, 'games', 'current'), (snap) => {
    if (snap.exists()) {
      state.phase = snap.data().status || 'setup';
    }
    render();
  });
}

function cleanNames(txt) {
  return txt.split('\n').map(l => {
    let c = l.trim().replace(/^\d+[\.\)\-\s]+/, '').replace(/[\d\.\)\-]+$/, '').replace(/\d+/g, '');
    return c.trim();
  }).filter(n => n.length > 0).slice(0, 21);
}

async function initGame() {
  const names = cleanNames(state.playerInput);
  if (!names.length) return;
  const players = names.map((n, i) => ({ id: 'player_'+i, name: n, available: true }));
  await setDoc(doc(db, 'games', 'current'), {
    status: 'captains', players, teams: [], participants: [], picks: [],
    turn: { order: [], index: 0, direction: 1 },
    settings: { snake: true }, pendingPick: null, lastPick: null
  });
  state.isHost = true;
  localStorage.setItem('draft21_is_host', 'true');
}

function toggleCap(id) {
  const idx = state.selectedCaptains.indexOf(id);
  if (idx > -1) state.selectedCaptains.splice(idx, 1);
  else if (state.selectedCaptains.length < 3) state.selectedCaptains.push(id);
  localStorage.setItem('draft21_selected_captains', JSON.stringify(state.selectedCaptains));
  render();
}

async function randCaps() {
  const snap = await getDoc(doc(db, 'games', 'current'));
  if (!snap.exists()) return;
  const avail = snap.data().players.filter(p => p.available);
  const shuf = avail.slice().sort(() => Math.random() - 0.5);
  state.selectedCaptains = shuf.slice(0, 3).map(p => p.id);
  const cols = ['Red', 'White', 'Black'];
  state.teamAssignments = {};
  state.selectedCaptains.forEach((c, i) => state.teamAssignments[c] = cols[i]);
  localStorage.setItem('draft21_selected_captains', JSON.stringify(state.selectedCaptains));
  localStorage.setItem('draft21_team_assignments', JSON.stringify(state.teamAssignments));
  render();
}

function assignT(cid, col) {
  state.teamAssignments[cid] = col;
  localStorage.setItem('draft21_team_assignments', JSON.stringify(state.teamAssignments));
  render();
}

async function finCaps() {
  if (state.selectedCaptains.length !== 3 || Object.keys(state.teamAssignments).length !== 3) return;
  const snap = await getDoc(doc(db, 'games', 'current'));
  if (!snap.exists()) return;
  const gd = snap.data();
  const teams = state.selectedCaptains.map(cid => {
    const cap = gd.players.find(p => p.id === cid);
    return { name: state.teamAssignments[cid], captain: cap.name, captainId: cid, players: [cap.name] };
  });
  const upd = gd.players.map(p => ({ ...p, available: !state.selectedCaptains.includes(p.id) }));
  await updateDoc(doc(db, 'games', 'current'), { teams, players: upd, status: 'lobby' });
}

async function joinLob() {
  if (!state.nickname.trim()) return;
  const pid = state.myId || 'p_'+Date.now();
  state.myId = pid;
  localStorage.setItem('draft21_nickname', state.nickname);
  localStorage.setItem('draft21_id', pid);
  await runTransaction(db, async (t) => {
    const snap = await t.get(doc(db, 'games', 'current'));
    if (!snap.exists()) return;
    const gd = snap.data();
    const mt = gd.teams.find(tm => tm.captain.toLowerCase() === state.nickname.trim().toLowerCase());
    const part = { id: pid, name: state.nickname, ready: false, teamName: mt ? mt.name : null };
    if (!gd.participants.some(p => p.id === pid)) {
      t.update(doc(db, 'games', 'current'), { participants: [...gd.participants, part] });
    }
  });
}

async function selTeam(tn) {
  await runTransaction(db, async (t) => {
    const snap = await t.get(doc(db, 'games', 'current'));
    if (!snap.exists()) return;
    const gd = snap.data();
    const upd = gd.participants.map(p => p.id === state.myId ? { ...p, teamName: tn } : p);
    t.update(doc(db, 'games', 'current'), { participants: upd });
  });
}

async function togReady() {
  await runTransaction(db, async (t) => {
    const snap = await t.get(doc(db, 'games', 'current'));
    if (!snap.exists()) return;
    const gd = snap.data();
    const my = gd.participants.find(p => p.id === state.myId);
    if (!my || !my.teamName) return;
    const upd = gd.participants.map(p => p.id === state.myId ? { ...p, ready: !p.ready } : p);
    t.update(doc(db, 'games', 'current'), { participants: upd });
  });
}

function togMan() {
  state.manualOrder = !state.manualOrder;
  if (!state.manualOrder) state.draftOrder = [];
  else {
    getDoc(doc(db, 'games', 'current')).then(snap => {
      if (snap.exists()) {
        state.draftOrder = snap.data().teams.map(t => t.name);
        render();
      }
    });
  }
  render();
}

function moveDO(tn, dir) {
  const ci = state.draftOrder.indexOf(tn);
  if (ci === -1) return;
  const ni = ci + dir;
  if (ni < 0 || ni >= state.draftOrder.length) return;
  const tmp = state.draftOrder[ci];
  state.draftOrder[ci] = state.draftOrder[ni];
  state.draftOrder[ni] = tmp;
  render();
}

function randDO() {
  state.draftOrder = state.draftOrder.slice().sort(() => Math.random() - 0.5);
  render();
}

async function startD() {
  const snap = await getDoc(doc(db, 'games', 'current'));
  if (!snap.exists()) return;
  const gd = snap.data();
  const parts = gd.participants.filter(p => p.ready);
  if (!parts.length) return;
  const trep = new Set(parts.map(p => p.teamName));
  if (trep.size !== gd.teams.length) { alert('×›×œ ×§×‘×•×¦×” ×¦×¨×™×›×” ××©×ª×ª×£!'); return; }
  const ac = gd.players.filter(p => p.available).length;
  const tc = gd.teams.length;
  const rnds = Math.ceil(ac / tc);
  let ord = [];
  const tns = gd.teams.map(t => t.name);
  if (state.manualOrder && state.draftOrder.length === tc) {
    for (let r = 0; r < rnds; r++) {
      ord = ord.concat(r % 2 === 0 ? state.draftOrder : state.draftOrder.slice().reverse());
    }
  } else {
    for (let r = 0; r < rnds; r++) {
      ord = ord.concat(r % 2 === 0 ? tns : tns.slice().reverse());
    }
  }
  await updateDoc(doc(db, 'games', 'current'), {
    status: 'drafting', turn: { order: ord, index: 0, direction: 1 },
    pendingPick: null, lastPick: null
  });
}

async function makePk(pid) {
  await runTransaction(db, async (t) => {
    const snap = await t.get(doc(db, 'games', 'current'));
    if (!snap.exists()) return;
    const gd = snap.data();
    const ctn = gd.turn.order[gd.turn.index];
    const my = gd.participants.find(p => p.id === state.myId);
    if (!my || my.teamName !== ctn) return;
    const pl = gd.players.find(p => p.id === pid);
    if (!pl || !pl.available) return;
    t.update(doc(db, 'games', 'current'), {
      pendingPick: { playerId: pid, playerName: pl.name, teamName: ctn }
    });
  });
}

async function confPk() {
  await runTransaction(db, async (t) => {
    const snap = await t.get(doc(db, 'games', 'current'));
    if (!snap.exists()) return;
    const gd = snap.data();
    if (!gd.pendingPick) return;
    const pl = gd.players.find(p => p.id === gd.pendingPick.playerId);
    const ctn = gd.pendingPick.teamName;
    const tm = gd.teams.find(t => t.name === ctn);
    const upp = gd.players.map(p => p.id === gd.pendingPick.playerId ? { ...p, available: false } : p);
    const upt = gd.teams.map(t => t.name === tm.name ? { ...t, players: [...t.players, pl.name] } : t);
    const pk = { playerId: gd.pendingPick.playerId, playerName: pl.name, team: tm.name,
      pickNumber: gd.picks.length + 1, timestamp: Date.now() };
    const lp = { playerId: pk.playerId, playerName: pk.playerName, teamName: pk.team, turnIndex: gd.turn.index };
    const ni = gd.turn.index + 1;
    const ap = upp.filter(p => p.available).length === 0;
    t.update(doc(db, 'games', 'current'), {
      players: upp, teams: upt, picks: [...gd.picks, pk], pendingPick: null, lastPick: lp,
      turn: { ...gd.turn, index: ni }, status: ap ? 'completed' : 'drafting'
    });
  });
  showConf();
}

async function undoPk() {
  await runTransaction(db, async (t) => {
    const snap = await t.get(doc(db, 'games', 'current'));
    if (!snap.exists()) return;
    const gd = snap.data();
    if (!gd.lastPick || !gd.picks.length) return;
    const lp = gd.lastPick;
    const upp = gd.players.map(p => p.id === lp.playerId ? { ...p, available: true } : p);
    const upt = gd.teams.map(t => t.name === lp.teamName ? 
      { ...t, players: t.players.filter(p => p !== lp.playerName) } : t);
    const upk = gd.picks.slice(0, -1);
    const nlp = upk.length > 0 ? {
      playerId: upk[upk.length-1].playerId, playerName: upk[upk.length-1].playerName,
      teamName: upk[upk.length-1].team, turnIndex: lp.turnIndex - 1
    } : null;
    t.update(doc(db, 'games', 'current'), {
      players: upp, teams: upt, picks: upk, turn: { ...gd.turn, index: lp.turnIndex },
      pendingPick: null, lastPick: nlp, status: gd.status === 'completed' ? 'drafting' : gd.status
    });
  });
}

async function canPend() {
  await updateDoc(doc(db, 'games', 'current'), { pendingPick: null });
}

async function rstDraft() {
  const snap = await getDoc(doc(db, 'games', 'current'));
  if (!snap.exists()) return;
  const gd = snap.data();
  await updateDoc(doc(db, 'games', 'current'), {
    picks: [], turn: { order: gd.turn.order, index: 0, direction: 1 },
    status: 'drafting', pendingPick: null, lastPick: null,
    players: gd.players.map(p => ({ ...p, available: !state.selectedCaptains.includes(p.id) })),
    teams: gd.teams.map(t => ({ ...t, players: [t.captain] }))
  });
}

async function shareWA() {
  const snap = await getDoc(doc(db, 'games', 'current'));
  if (!snap.exists()) return;
  const gd = snap.data();
  let msg = 'âš½ ×ª×•×¦××•×ª ×”×“×¨××¤×˜:\n\n';
  gd.teams.forEach(t => {
    const c = t.name === 'Red' ? 'ğŸ”´' : t.name === 'White' ? 'âšª' : 'âš«';
    msg += c + ' ×§×‘×•×¦×” ' + t.name + '\n×§×¤×˜×Ÿ: ' + t.captain + '\n×©×—×§× ×™×: ' + t.players.join(', ') + '\n\n';
  });
  window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
}

function showConf() {
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.textContent = ['ğŸ‰','âš½','ğŸ†','âœ¨','ğŸŠ'][Math.floor(Math.random()*5)];
      c.style.left = Math.random()*100 + '%';
      c.style.top = '-50px';
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 3000);
    }, i * 50);
  }
}

async function fullRst() {
  if (!confirm('××—×™×§×” ××•×—×œ×˜×ª?')) return;
  localStorage.clear();
  await setDoc(doc(db, 'games', 'current'), {
    status: 'setup', players: [], teams: [], participants: [], picks: [],
    turn: { order: [], index: 0, direction: 1 }, settings: { snake: true },
    pendingPick: null, lastPick: null
  });
  state = { phase: 'setup', playerInput: '', nickname: '', myId: '', isHost: false,
    selectedCaptains: [], teamAssignments: {}, draftOrder: [], manualOrder: false };
}

function getTurn(gd) {
  if (!gd || state.phase !== 'drafting') return null;
  const ctn = gd.turn.order[gd.turn.index];
  const tm = gd.teams.find(t => t.name === ctn);
  const my = gd.participants.find(p => p.id === state.myId);
  return { team: tm, captain: tm.captain, isMyTurn: my && my.teamName === ctn };
}

function render() {
  getDoc(doc(db, 'games', 'current')).then(snap => {
    const gd = snap.exists() ? snap.data() : null;
    const a = document.getElementById('app');
    if (state.phase === 'setup' || !gd || !gd.players.length) a.innerHTML = rSetup();
    else if (state.phase === 'captains') a.innerHTML = rCaps(gd);
    else if (state.phase === 'lobby') a.innerHTML = rLobby(gd);
    else if (state.phase === 'drafting') a.innerHTML = rDraft(gd);
    else if (state.phase === 'completed') a.innerHTML = rComp(gd);
  });
}

function rSetup() {
  return '<div class="min-h-screen bg-gradient-to-br from-green-500 to-blue-600 p-4 flex items-center justify-center">' +
    '<div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full"><div class="text-center mb-6">' +
    '<div class="text-6xl mb-4">ğŸ†</div><h1 class="text-4xl font-bold text-gray-800">Draft21</h1>' +
    '<p class="text-gray-600 mt-2">×›×œ×™ ×“×¨××¤×˜ ×›×“×•×¨×’×œ ×‘×–××Ÿ ×××ª</p>' +
    '<div class="mt-2 inline-flex items-center gap-2 text-xs text-green-600 bg-green-50 px-3 py-1 rounded-full">' +
    '<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>ğŸŒ ×¢×•×‘×“ ×‘×™×Ÿ ×›×œ ×”××›×©×™×¨×™×</div></div>' +
    '<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">×”×“×‘×§ ×¨×©×™××ª ×©×—×§× ×™× (×¢×“ 21)</label>' +
    '<textarea id="playerInput" placeholder="1. ×“×•×“&#10;2. ×™×•××‘&#10;3. ××œ×•×Ÿ" class="w-full h-48 p-3 border-2 border-gray-300 rounded-lg"></textarea></div>' +
    '<button onclick="hInitG()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 rounded-xl font-bold text-lg">×”×ª×—×œ ×”×’×“×¨×ª ×“×¨××¤×˜</button>' +
    '<button onclick="hFullR()" class="w-full bg-red-100 text-red-700 py-2 rounded-lg text-sm hover:bg-red-200">ğŸ”„ ××™×¤×•×¡ ××œ×</button></div></div></div>';
}

function rCaps(gd) {
  const sc = state.selectedCaptains.length;
  const ac = Object.keys(state.teamAssignments).length;
  let h = '<div class="min-h-screen bg-gradient-to-br from-purple-500 to-pink-600 p-4"><div class="max-w-4xl mx-auto">' +
    '<div class="bg-white rounded-3xl shadow-2xl p-8 mb-6"><h2 class="text-3xl font-bold mb-2">×‘×—×¨ 3 ×§×¤×˜× ×™×</h2>' +
    '<p class="text-gray-600 mb-6">×œ×—×¥ ×¢×œ ×©×—×§× ×™× ××• ×”×’×¨×œ</p><div class="flex gap-4 mb-6">' +
    '<button onclick="hRandC()" class="bg-purple-500 text-white px-6 py-3 rounded-xl hover:bg-purple-600">ğŸ”€ ×”×’×¨×œ ×§×¤×˜× ×™× ×•×§×‘×•×¦×•×ª</button></div>' +
    '<div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">';
  gd.players.filter(p => p.available).forEach(pl => {
    const sel = state.selectedCaptains.includes(pl.id);
    h += '<button onclick="hTogC(\'' + pl.id + '\')" class="p-4 rounded-xl border-2 ' +
      (sel ? 'bg-blue-500 text-white border-blue-600 scale-105' : 'bg-gray-50 border-gray-300 hover:border-blue-400') +
      '">' + pl.name + '</button>';
  });
  h += '</div>';
  if (sc === 3) {
    h += '<div class="space-y-4 mb-6"><h3 class="text-xl font-bold mb-4">×”×§×¦×” ×¦×‘×¢×™ ×—×•×œ×¦×•×ª</h3>';
    state.selectedCaptains.forEach(cid => {
      const cap = gd.players.find(p => p.id === cid);
      const asn = state.teamAssignments[cid];
      h += '<div class="flex items-center gap-4 bg-gray-50 p-4 rounded-xl"><span class="font-bold w-32">' + cap.name + '</span>';
      if (asn) {
        h += '<span class="text-sm text-gray-600">â†’</span><div class="flex items-center gap-2">' +
          '<div class="w-8 h-8 rounded-full ' + TEAM_COLORS[asn].bg + '"></div><span class="font-medium">' + asn + '</span></div>';
      }
      h += '<div class="flex gap-2 mr-auto">';
      Object.keys(TEAM_COLORS).forEach(col => {
        const isA = state.teamAssignments[cid] === col;
        const isU = Object.values(state.teamAssignments).includes(col) && !isA;
        h += '<button onclick="hAssT(\'' + cid + '\',\'' + col + '\')" ' + (isU ? 'disabled' : '') +
          ' class="w-16 h-16 rounded-full border-4 ' + TEAM_COLORS[col].bg + ' ' +
          (isA ? 'border-yellow-400 scale-110 shadow-lg' : 'border-gray-300 opacity-50') + ' ' +
          (isU ? 'opacity-30 cursor-not-allowed' : 'hover:scale-105') + '"></button>';
      });
      h += '</div></div>';
    });
    h += '</div>';
  }
  h += '<button onclick="hFinC()" ' + (sc !== 3 || ac !== 3 ? 'disabled' : '') +
    ' class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-4 rounded-xl font-bold disabled:opacity-50">×”××©×š ×œ×œ×•×‘×™</button></div></div></div>';
  return h;
}

function rLobby(gd) {
  const my = gd.participants.find(p => p.id === state.myId);
  const rc = gd.participants.filter(p => p.ready).length;
  let h = '<div class="min-h-screen bg-gradient-to-br from-blue-500 to-indigo-600 p-4"><div class="max-w-2xl mx-auto">' +
    '<div class="bg-white rounded-3xl shadow-2xl p-8"><div class="text-center mb-8"><div class="text-6xl mb-4">ğŸ‘¥</div>' +
    '<h2 class="text-3xl font-bold mb-2">×œ×•×‘×™ ×”×“×¨××¤×˜</h2><p class="text-gray-600">××—×›×™× ×œ×©×—×§× ×™×...</p>' +
    '<div class="mt-2 inline-flex items-center gap-2 text-xs text-green-600 bg-green-50 px-3 py-1 rounded-full">' +
    '<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>××¡×•× ×›×¨×Ÿ ×‘×–××Ÿ ×××ª</div></div>';
  if (!my) {
    h += '<div class="mb-6"><input id="nickIn" placeholder="×”×›× ×¡ ×›×™× ×•×™" class="w-full p-4 border-2 rounded-xl mb-4" />' +
      '<button onclick="hJoinL()" class="w-full bg-blue-500 text-white py-4 rounded-xl font-bold hover:bg-blue-600">×”×¦×˜×¨×£ ×œ×œ×•×‘×™</button></div>';
  }
  h += '<div class="space-y-3 mb-6">';
  gd.participants.forEach(p => {
    const tm = p.teamName ? gd.teams.find(t => t.name === p.teamName) : null;
    h += '<div class="flex items-center justify-between p-4 rounded-xl ' +
      (p.ready ? 'bg-green-100 border-2 border-green-500' : 'bg-gray-100 border-2 border-gray-300') + '">' +
      '<div class="flex items-center gap-3">' +
      (tm ? '<div class="w-8 h-8 rounded-full ' + TEAM_COLORS[tm.name].bg + '"></div>' : '') +
      '<div><span class="font-medium block">' + p.name + '</span>' +
      (tm ? '<span class="text-xs text-gray-600">×§×‘×•×¦×”: ' + tm.name + '</span>' : '<span class="text-xs text-red-600">×œ× ×‘×—×¨ ×§×‘×•×¦×”</span>') +
      '</div></div>' + (p.ready ? '<span class="text-2xl">âœ“</span>' : '') + '</div>';
  });
  h += '</div>';
  if (my) {
    if (!my.teamName) {
      h += '<div class="mb-4 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-xl">' +
        '<p class="font-bold text-yellow-800 mb-3 text-center">×‘×—×¨ ××ª ×”×§×‘×•×¦×” ×©×œ×š:</p><div class="grid grid-cols-3 gap-3">';
      gd.teams.forEach(t => {
        const taken = gd.participants.some(p => p.teamName === t.name && p.id !== state.myId);
        h += '<button onclick="hSelT(\'' + t.name + '\')" ' + (taken ? 'disabled' : '') +
          ' class="p-4 rounded-xl ' + (taken ? 'bg-gray-200 opacity-50 cursor-not-allowed' : 'bg-white border-2 border-gray-300 hover:border-blue-500') + '">' +
          '<div class="w-12 h-12 rounded-full ' + TEAM_COLORS[t.name].bg + ' mx-auto mb-2"></div>' +
          '<p class="font-bold text-sm">' + t.name + '</p><p class="text-xs text-gray-600">' + t.captain + '</p>' +
          (taken ? '<p class="text-xs text-red-600 mt-1">×ª×¤×•×¡</p>' : '') + '</button>';
      });
      h += '</div></div>';
    }
    h += '<button onclick="hTogR()" ' + (!my.teamName ? 'disabled' : '') +
      ' class="w-full py-4 rounded-xl font-bold mb-4 ' +
      (!my.teamName ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : my.ready ? 'bg-gray-300 text-gray-700' : 'bg-green-500 text-white hover:bg-green-600') +
      '">' + (my.ready ? '×‘×™×˜×•×œ ××•×›×Ÿ' : my.teamName ? '×× ×™ ××•×›×Ÿ!' : '×‘×—×¨ ×§×‘×•×¦×” ×§×•×“×') + '</button>';
  }
  if (state.isHost && rc > 0) {
    h += '<div class="border-t-2 pt-6 mt-6"><h3 class="text-xl font-bold mb-4">×”×’×“×¨×•×ª ×“×¨××¤×˜</h3><div class="mb-4">' +
      '<button onclick="hTogMan()" class="w-full py-3 rounded-xl font-medium ' +
      (state.manualOrder ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-700') + '">' +
      (state.manualOrder ? 'âœ“ ×¡×“×¨ ×™×“× ×™ ×¤×¢×™×œ' : '×¡×“×¨ ××§×¨××™ (×œ×—×¥ ×œ×¡×“×¨ ×™×“× ×™)') + '</button></div>';
    if (state.manualOrder && state.draftOrder.length > 0) {
      h += '<div class="bg-gray-50 rounded-xl p-4 mb-4"><div class="flex items-center justify-between mb-3">' +
        '<h4 class="font-bold text-gray-700">×¡×“×¨ ×”×§×‘×•×¦×•×ª:</h4>' +
        '<button onclick="hRandDO()" class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded-lg hover:bg-purple-200">ğŸ”€ ×¢×¨×‘×‘</button></div>' +
        '<p class="text-xs text-gray-500 mb-3">×”×¡×“×¨ ×™×”×¤×•×š ×›×œ ×¡×™×‘×•×‘</p><div class="space-y-2">';
      state.draftOrder.forEach((tn, idx) => {
        const tm = gd.teams.find(t => t.name === tn);
        if (tm) {
          h += '<div class="flex items-center gap-2 bg-white p-3 rounded-lg"><span class="font-bold text-lg text-gray-500 w-8">' + (idx+1) + '.</span>' +
            '<div class="w-8 h-8 rounded-full ' + TEAM_COLORS[tn].bg + '"></div><div class="flex-1">' +
            '<span class="font-bold">' + tn + '</span><span class="text-sm text-gray-500 mr-2">(' + tm.captain + ')</span></div>' +
            '<div class="flex gap-1"><button onclick="hMoveDO(\'' + tn + '\',-1)" ' + (idx === 0 ? 'disabled' : '') +
            ' class="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-30">â†‘</button>' +
            '<button onclick="hMoveDO(\'' + tn + '\',1)" ' + (idx === state.draftOrder.length-1 ? 'disabled' : '') +
            ' class="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-30">â†“</button></div></div>';
        }
      });
      h += '</div></div>';
    }
    h += '</div>';
  }
  if (state.isHost) {
    h += '<button onclick="hStartD()" ' + (rc === 0 ? 'disabled' : '') +
      ' class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-4 rounded-xl font-bold text-lg disabled:opacity-50 flex items-center justify-center gap-2">â–¶ï¸ ×”×ª×—×œ ×“×¨××¤×˜ (' + rc + ' ××•×›× ×™×)</button>';
  }
  h += '</div></div></div>';
  return h;
}

function rDraft(gd) {
  const ti = getTurn(gd);
  let h = '<div class="min-h-screen bg-gradient-to-br from-green-600 to-teal-600 p-4"><div class="max-w-6xl mx-auto">';
  if (ti) {
    h += '<div class="mb-6 p-6 rounded-3xl shadow-xl ' + (ti.isMyTurn ? 'bg-yellow-400 animate-pulse' : 'bg-white') + '">' +
      '<div class="text-center"><p class="text-2xl font-bold mb-2">' +
      (ti.isMyTurn ? 'ğŸ”¥ ×”×ª×•×¨ ×©×œ×š ×œ×‘×—×•×¨! ğŸ”¥' : 'â³ ×”×ª×•×¨ ×©×œ: ' + ti.captain) + '</p>' +
      '<p class="text-lg font-medium">×§×‘×•×¦×”: <span class="font-bold">' + ti.team.name + '</span></p>' +
      '<div class="mt-2 inline-flex items-center gap-2 text-xs ' + (ti.isMyTurn ? 'text-gray-700' : 'text-green-600') + ' bg-white bg-opacity-50 px-3 py-1 rounded-full">' +
      '<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>××¡×•× ×›×¨×Ÿ ×‘×–××Ÿ ×××ª</div></div></div>';
  }
  if (gd.pendingPick) {
    h += '<div class="mb-6 p-6 rounded-2xl bg-orange-100 border-4 border-orange-400 shadow-xl">' +
      '<div class="text-center"><p class="text-lg font-bold text-orange-800 mb-3">âœ“ × ×‘×—×¨: ' + gd.pendingPick.playerName + '</p>' +
      '<div class="flex gap-3 justify-center">' +
      '<button onclick="hConfP()" class="bg-green-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-600">âœ“ ×¡×™×™××ª×™ - ×¢×‘×•×¨ ×œ×ª×•×¨ ×”×‘×</button>' +
      '<button onclick="hCanPend()" class="bg-gray-400 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-500">âœ— ×‘×˜×œ ×‘×—×™×¨×”</button>' +
      '</div></div></div>';
  }
  h += '<div class="bg-white rounded-3xl shadow-2xl p-6 mb-6"><div class="flex items-center justify-between mb-4">' +
    '<h3 class="text-2xl font-bold">×©×—×§× ×™× ×–××™× ×™×</h3>';
  if (state.isHost && gd.lastPick) {
    h += '<button onclick="hUndoP()" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg font-bold hover:bg-red-200">â†¶ ××—×•×¨×”</button>';
  }
  h += '</div><div class="grid grid-cols-2 md:grid-cols-4 gap-3">';
  gd.players.filter(p => p.available).forEach(pl => {
    const canP = ti && ti.isMyTurn && !gd.pendingPick;
    const isPend = gd.pendingPick && gd.pendingPick.playerId === pl.id;
    h += '<button onclick="hMakePk(\'' + pl.id + '\')" ' + (!canP ? 'disabled' : '') +
      ' class="p-4 rounded-xl border-2 ' +
      (isPend ? 'bg-orange-400 text-white border-orange-600 scale-105 animate-pulse' : 
       canP ? 'bg-gradient-to-br from-blue-400 to-purple-500 text-white border-purple-600 hover:scale-105' : 
       'bg-gray-100 text-gray-500 border-gray-300 cursor-not-allowed') + '">' + pl.name + '</button>';
  });
  h += '</div></div><div class="grid md:grid-cols-3 gap-4 mb-6">';
  gd.teams.forEach(t => {
    h += '<div class="bg-white rounded-3xl shadow-xl p-6">' +
      '<div class="w-12 h-12 rounded-full ' + TEAM_COLORS[t.name].bg + ' mx-auto mb-3"></div>' +
      '<h3 class="text-xl font-bold text-center mb-2">' + t.name + '</h3>' +
      '<p class="text-sm text-gray-600 text-center mb-4">×§×¤×˜×Ÿ: ' + t.captain + '</p><div class="space-y-2">';
    t.players.forEach(p => {
      h += '<div class="bg-gray-100 p-2 rounded-lg text-center text-sm">' + p + '</div>';
    });
    h += '</div></div>';
  });
  h += '</div>';
  if (state.isHost) {
    h += '<div class="flex gap-2"><button onclick="hRstD()" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600">ğŸ”„ ××¤×¡ ×“×¨××¤×˜</button>' +
      '<button onclick="hFullR()" class="px-4 bg-gray-500 text-white py-3 rounded-xl font-bold hover:bg-gray-600" title="××™×¤×•×¡ ××œ×">ğŸ—‘ï¸</button></div>';
  }
  h += '</div></div>';
  return h;
}

function rComp(gd) {
  let h = '<div class="min-h-screen bg-gradient-to-br from-yellow-400 to-orange-500 p-4"><div class="max-w-4xl mx-auto">' +
    '<div class="bg-white rounded-3xl shadow-2xl p-8 mb-6"><div class="text-center mb-8">' +
    '<div class="text-7xl mb-4 animate-bounce">ğŸ†</div><h2 class="text-4xl font-bold mb-2">×”×“×¨××¤×˜ ×”×¡×ª×™×™×!</h2>' +
    '<p class="text-gray-600">×”× ×” ×”×§×‘×•×¦×•×ª ×©×œ×›×</p></div><div class="grid md:grid-cols-3 gap-6 mb-8">';
  gd.teams.forEach(t => {
    h += '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 border-4 border-gray-300">' +
      '<div class="w-16 h-16 rounded-full ' + TEAM_COLORS[t.name].bg + ' mx-auto mb-4"></div>' +
      '<h3 class="text-2xl font-bold text-center mb-3">' + t.name + '</h3>' +
      '<div class="bg-yellow-100 border-2 border-yellow-400 rounded-lg p-3 mb-4">' +
      '<p class="text-center font-bold text-yellow-800">ğŸ‘‘ ' + t.captain + '</p></div><div class="space-y-2">';
    t.players.filter(p => p !== t.captain).forEach(p => {
      h += '<div class="bg-white p-3 rounded-lg text-center border border-gray-200">' + p + '</div>';
    });
    h += '</div></div>';
  });
  h += '</div><div class="space-y-4">' +
    '<button onclick="hShareWA()" class="w-full bg-green-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-600 flex items-center justify-center gap-2">ğŸ“¤ ×©×ª×£ ×‘×•×•××˜×¡××¤</button>';
  if (state.isHost) {
    h += '<div class="flex gap-2">' +
      '<button onclick="hRstD()" class="flex-1 bg-gray-500 text-white py-3 rounded-xl font-bold hover:bg-gray-600">ğŸ”„ ×”×ª×—×œ ×“×¨××¤×˜ ×—×“×©</button>' +
      '<button onclick="hFullR()" class="px-4 bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600" title="××™×¤×•×¡ ××œ×">ğŸ—‘ï¸</button></div>';
  }
  h += '</div></div></div></div>';
  return h;
}

window.hInitG = () => { state.playerInput = document.getElementById('playerInput').value; initGame(); };
window.hTogC = toggleCap;
window.hRandC = randCaps;
window.hAssT = assignT;
window.hFinC = finCaps;
window.hJoinL = () => { state.nickname = document.getElementById('nickIn').value; joinLob(); };
window.hSelT = selTeam;
window.hTogR = togReady;
window.hTogMan = togMan;
window.hMoveDO = moveDO;
window.hRandDO = randDO;
window.hStartD = startD;
window.hMakePk = makePk;
window.hConfP = confPk;
window.hUndoP = undoPk;
window.hCanPend = canPend;
window.hRstD = rstDraft;
window.hShareWA = shareWA;
window.hFullR = fullRst;

init();
</script>
</body>
</html>
